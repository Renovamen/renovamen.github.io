<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <link rel="canonical" href="https://zxh.io/posts/2022-12-19-monocular-visual-odometry/">
    <meta name="generator" content="Astro v2.5.5">
    <meta name="msapplication-TileColor" content="#ffffff">

    <title>Implement Monocular Visual Odometry - Xiaohan Zou</title>

    <!-- General Meta Tags -->
    <meta name="title" content="Implement Monocular Visual Odometry - Xiaohan Zou">
    <meta name="description" content="A dragon lost in human world.">
    <meta name="author" content="Xiaohan Zou">

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content="Implement Monocular Visual Odometry - Xiaohan Zou">
    <meta property="og:description" content="A dragon lost in human world.">
    <meta property="og:url" content="https://zxh.io/posts/2022-12-19-monocular-visual-odometry/">

    <!-- Twitter -->
    <meta property="twitter:title" content="Implement Monocular Visual Odometry - Xiaohan Zou">
    <meta property="twitter:description" content="A dragon lost in human world.">
    <meta property="twitter:url" content="https://zxh.io/posts/2022-12-19-monocular-visual-odometry/">

    
  <link rel="stylesheet" href="/_astro/404.9f051a48.css" />
<link rel="stylesheet" href="/_astro/index.90e3680a.css" />
<link rel="stylesheet" href="/_astro/_slug_.8db38b5a.css" /><script type="module" src="/_astro/hoisted.aef143c1.js"></script></head>

  <body class="font-sans">
    <main class="post astro-GVPN4U4B flex flex-col min-h-full text-c px-4 pt-24 pb-4 md:pb-6">
      <style>astro-island,astro-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var l;{let c={0:t=>t,1:t=>JSON.parse(t,o),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(JSON.parse(t,o)),5:t=>new Set(JSON.parse(t,o)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(JSON.parse(t)),9:t=>new Uint16Array(JSON.parse(t)),10:t=>new Uint32Array(JSON.parse(t))},o=(t,s)=>{if(t===""||!Array.isArray(s))return s;let[e,n]=s;return e in c?c[e](n):void 0};customElements.get("astro-island")||customElements.define("astro-island",(l=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=()=>{if(!this.hydrator||this.parentElement&&this.parentElement.closest("astro-island[ssr]"))return;let s=this.querySelectorAll("astro-slot"),e={},n=this.querySelectorAll("template[data-astro-template]");for(let r of n){let i=r.closest(this.tagName);!i||!i.isSameNode(this)||(e[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of s){let i=r.closest(this.tagName);!i||!i.isSameNode(this)||(e[r.getAttribute("name")||"default"]=r.innerHTML)}let a=this.hasAttribute("props")?JSON.parse(this.getAttribute("props"),o):{};this.hydrator(this)(this.Component,a,e,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),window.removeEventListener("astro:hydrate",this.hydrate),window.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((s,e)=>{e.disconnect(),this.childrenConnectedCallback()}).observe(this,{childList:!0})}async childrenConnectedCallback(){window.addEventListener("astro:hydrate",this.hydrate);let s=this.getAttribute("before-hydration-url");s&&await import(s),this.start()}start(){let s=JSON.parse(this.getAttribute("opts")),e=this.getAttribute("client");if(Astro[e]===void 0){window.addEventListener(`astro:${e}`,()=>this.start(),{once:!0});return}Astro[e](async()=>{let n=this.getAttribute("renderer-url"),[a,{default:r}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let d of i.split("."))this.Component=this.Component[d]}return this.hydrator=r,this.hydrate},s,this)}attributeChangedCallback(){this.hydrator&&this.hydrate()}},l.observedAttributes=["props"],l))}})();</script><astro-island uid="Z1kQxaa" data-solid-render-id="s2" component-url="/_astro/Navbar.77a1f8e2.js" component-export="default" renderer-url="/_astro/client.6684d98a.js" props="{&quot;activePage&quot;:[0,&quot;posts&quot;],&quot;hasToc&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;Navbar&quot;,&quot;value&quot;:true}" await-children=""><header data-hk="s20-0" class="z-30 w-full h-14 hstack justify-between bg-c font-ui px-4 md:px-5 false false absolute top-0 left-0"><a font-bold text="c-light hover:c-dark" href="/"><span text-lg>hi@zxh</span><div i-fa6-solid:angle-right class="prompt inline-block"></div><span class="blink">_</span></a><nav hstack space-x-4><a nav-item href="/projects" title="Projects"><div i-ph:rocket-launch-duotone class="md:hidden"></div><span class="lt-md:hidden false">Projects</span></a><a nav-item href="/posts" title="Blog"><div i-majesticons:pencil-line class="md:hidden"></div><span class="lt-md:hidden active">Blog</span></a><a nav-item href="/search" title="Search"><span i-uil:search></span></a><button nav-item title="Toggle dark"><div i="carbon-sun dark:carbon-moon"></div></button><!--#--><button data-hk="s20-1-0" class="nav-item ml-4" title="Toggle toc"><div data-hk="s20-1-1" i-ri:menu-3-line></div></button><!--/--></nav></header></astro-island>
      <div class="flex-1 mb-6">
        <div class="prose prose-lg mx-auto">
          
  <div mt-6 mb-8 class="astro-GVPN4U4B">
    <h1 text-4xl font-bold leading-12 my-0 class="astro-GVPN4U4B">Implement Monocular Visual Odometry</h1>
    <p text-c-lighter mt-2 class="astro-GVPN4U4B">
      Dec 19, 2022 · 11 min
      <span class="astro-GVPN4U4B">
            ·
            <span i-uil:tag-alt text-sm class="astro-GVPN4U4B"></span>
            <span class="astro-GVPN4U4B">
                <a href="/posts/tags/computer-vision" class="!text-c astro-GVPN4U4B">
                  computer vision
                </a>
                
              </span>
          </span>
    </p>
  </div>

  <div class="content mb-16 astro-GVPN4U4B">
    <astro-island uid="Z19GKs" data-solid-render-id="s0" component-url="/_astro/TocButtons.ef0a5982.js" component-export="default" renderer-url="/_astro/client.6684d98a.js" props="{&quot;prev&quot;:[0,&quot;2022-06-28-new-mac&quot;],&quot;next&quot;:[0,&quot;2022-12-29-natural-gradient-decent&quot;],&quot;class&quot;:[0,&quot;astro-GVPN4U4B&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;TocButtons&quot;,&quot;value&quot;:true}" await-children=""><div data-hk="s00-0" class="table-of-contents-btns fixed z-20"><div hstack justify-end pt-18 pb-2 bg-c><!--#--><span data-hk="s00-1" text="sm c-light" italic mr-3></span><!--/--><!--#--><a data-hk="s00-2" class="flex-center !text-c hover:opacity-60" href="/posts/2022-06-28-new-mac"><span i-ic:round-keyboard-arrow-left text-xl></span></a><!--/--><!--#--><a data-hk="s00-3" href="/posts/2022-12-29-natural-gradient-decent" class="flex-center !text-c hover:opacity-60"><span i-ic:round-keyboard-arrow-right text-xl></span></a><!--/--><button flex-center hover:opacity-60><span i-ic:round-keyboard-arrow-up text-xl></span></button><button class="flex-center hover:opacity-60 ml-1.5"><span i-mi:print text-sm></span></button></div></div></astro-island>
    <ul class="table-of-contents">
<li>
<p><a href="#problem">Problem</a></p>
</li>
<li>
<p><a href="#feature-detection">Feature Detection</a></p>
</li>
<li>
<p><a href="#feature-tracking">Feature Tracking</a></p>
</li>
<li>
<p><a href="#fundamental-matrix">Fundamental Matrix</a></p>
<ul>
<li><a href="#_8-point-algorithm">8-Point Algorithm</a></li>
<li><a href="#ransac">RANSAC</a></li>
</ul>
</li>
<li>
<p><a href="#essential-matrix">Essential Matrix</a></p>
</li>
<li>
<p><a href="#camera-pose">Camera Pose</a></p>
</li>
<li>
<p><a href="#trajectory">Trajectory</a></p>
</li>
<li>
<p><a href="#references">References</a></p>
</li>
</ul>
<p>Monocular Visual Odometry (VO) is the process of estimating the pose (position and orientation) of a camera using only visual information from a single camera. It is a crucial component of many robotics and augmented reality systems, as it allows a device to understand its own movement and position in the world.</p>
<p>This blog would be focussing on how to implement a simple monocular VO algorithm in Python. If you are new to it, I suggest having a look at <a href="https://cmsc426.github.io/sfm/" target="_blank" rel="noopener noreferrer">this article</a>.</p>
<p>The overall process can be broken down into the following steps:</p>
<ul>
<li>Feature detection</li>
<li>Feature tracking</li>
<li>Estimating fundamental matrix</li>
<li>Estimating essential matrix (from fundamental matrix)</li>
<li>Recovering pose (from essential matrix)</li>
</ul>
<h2 id="problem"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#problem">#</a>Problem</h2>
<p>Suppose that we have a camera attached to a vehicle. A video coming from this camera has been processed for lens distortion and converted to frames. We denote the frames captured at time <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> as <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">I_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span>, respectively. For every pair of images <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>I</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(I_i, I_{i+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>, our job is to find the rotation matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and the translation vector <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">t_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, which describe the motion of the vehicle between the two frames.</p>
<h2 id="feature-detection"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#feature-detection">#</a>Feature Detection</h2>
<p>We first look for salient landmarks, called keypoints <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, in <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">I_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>. Keypoints are features that differ from their immediate neighborhood such as corners or areas with unique colors or textures. These features should ideally be found in both two adjacent frames.</p>
<p>Using OpenCV, detecting keypoints is trivial:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #D73A49">import</span><span style="color: #24292E"> cv2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">detect_features</span><span style="color: #24292E">(image):</span></span>
<span class="line"><span style="color: #24292E">    detector </span><span style="color: #D73A49">=</span><span style="color: #24292E"> cv2.GFTTDetector_create()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    kp </span><span style="color: #D73A49">=</span><span style="color: #24292E"> detector.detect(image)</span></span>
<span class="line"><span style="color: #24292E">    kp </span><span style="color: #D73A49">=</span><span style="color: #24292E"> cv2.KeyPoint_convert(</span><span style="color: #005CC5">sorted</span><span style="color: #24292E">(kp, </span><span style="color: #E36209">key</span><span style="color: #D73A49">=lambda</span><span style="color: #24292E"> p: p.response, </span><span style="color: #E36209">reverse</span><span style="color: #D73A49">=</span><span style="color: #005CC5">True</span><span style="color: #24292E">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> kp</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">kp1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> detect_features(image1)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> cv2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">detect_features</span><span style="color: #E1E4E8">(image):</span></span>
<span class="line"><span style="color: #E1E4E8">    detector </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> cv2.GFTTDetector_create()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    kp </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> detector.detect(image)</span></span>
<span class="line"><span style="color: #E1E4E8">    kp </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> cv2.KeyPoint_convert(</span><span style="color: #79B8FF">sorted</span><span style="color: #E1E4E8">(kp, </span><span style="color: #FFAB70">key</span><span style="color: #F97583">=lambda</span><span style="color: #E1E4E8"> p: p.response, </span><span style="color: #FFAB70">reverse</span><span style="color: #F97583">=</span><span style="color: #79B8FF">True</span><span style="color: #E1E4E8">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> kp</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">kp1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> detect_features(image1)</span></span></code></pre></div>
</div>
<p>Here GFTT (Good Features to Track) detector is used to detect keypoints. In my experiments, other detectors like SIFT (Scale Invariant Feature Transform) and ORB (Oriented Fast and Rotated Brief) perform worse than GFTT. Meanwhile, the speed of SIFT is much slower.</p>
<h2 id="feature-tracking"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#feature-tracking">#</a>Feature Tracking</h2>
<p>We then need to track <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>’s corresponding keypoints <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">K_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span> in <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span> using optical flow. To improve the performance, you can choose to remove the keypoints that are not tracked in <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span> (<code>status</code> returned by <code>cv2.calcOpticalFlowPyrLK</code> is 0) or are outside <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span>.</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">get_removed_pts_ids</span><span style="color: #24292E">(pts, image, status):</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #032F62">"""Removes keypoints that are not tracked or are outside the image."""</span></span>
<span class="line"><span style="color: #24292E">    status_ </span><span style="color: #D73A49">=</span><span style="color: #24292E"> status.copy()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> idx, pt </span><span style="color: #D73A49">in</span><span style="color: #24292E"> </span><span style="color: #005CC5">enumerate</span><span style="color: #24292E">(pts):</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> pt[</span><span style="color: #005CC5">0</span><span style="color: #24292E">] </span><span style="color: #D73A49">&#x3C;</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E"> </span><span style="color: #D73A49">or</span><span style="color: #24292E"> pt[</span><span style="color: #005CC5">1</span><span style="color: #24292E">] </span><span style="color: #D73A49">&#x3C;</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E"> </span><span style="color: #D73A49">or</span><span style="color: #24292E"> pt[</span><span style="color: #005CC5">0</span><span style="color: #24292E">] </span><span style="color: #D73A49">></span><span style="color: #24292E"> image.shape[</span><span style="color: #005CC5">1</span><span style="color: #24292E">] </span><span style="color: #D73A49">or</span><span style="color: #24292E"> pt[</span><span style="color: #005CC5">1</span><span style="color: #24292E">] </span><span style="color: #D73A49">></span><span style="color: #24292E"> image.shape[</span><span style="color: #005CC5">0</span><span style="color: #24292E">]:</span></span>
<span class="line"><span style="color: #24292E">            status_[idx] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> np.where(status_ </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">)[</span><span style="color: #005CC5">0</span><span style="color: #24292E">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">track_features</span><span style="color: #24292E">(image1, image2, kp1, remove_outliers: </span><span style="color: #005CC5">bool</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">False</span><span style="color: #24292E">):</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #032F62">"""Tracks features using optical flow."""</span></span>
<span class="line"><span style="color: #24292E">    kp2, status, _ </span><span style="color: #D73A49">=</span><span style="color: #24292E"> cv2.calcOpticalFlowPyrLK(image1, image2, kp1, </span><span style="color: #005CC5">None</span><span style="color: #24292E">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> remove_outliers:</span></span>
<span class="line"><span style="color: #24292E">        removed_ids </span><span style="color: #D73A49">=</span><span style="color: #24292E"> get_removed_pts_ids(kp2, image2, status)</span></span>
<span class="line"><span style="color: #24292E">        kp1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.delete(kp1, removed_ids, </span><span style="color: #E36209">axis</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">        kp2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.delete(kp2, removed_ids, </span><span style="color: #E36209">axis</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> kp1, kp2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">kp1, kp2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> track_features(image1, image2, kp1, </span><span style="color: #E36209">remove_outliers</span><span style="color: #D73A49">=</span><span style="color: #005CC5">True</span><span style="color: #24292E">)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">get_removed_pts_ids</span><span style="color: #E1E4E8">(pts, image, status):</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"""Removes keypoints that are not tracked or are outside the image."""</span></span>
<span class="line"><span style="color: #E1E4E8">    status_ </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> status.copy()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> idx, pt </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">enumerate</span><span style="color: #E1E4E8">(pts):</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> pt[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">or</span><span style="color: #E1E4E8"> pt[</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">or</span><span style="color: #E1E4E8"> pt[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">></span><span style="color: #E1E4E8"> image.shape[</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">or</span><span style="color: #E1E4E8"> pt[</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">></span><span style="color: #E1E4E8"> image.shape[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">]:</span></span>
<span class="line"><span style="color: #E1E4E8">            status_[idx] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> np.where(status_ </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">)[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">track_features</span><span style="color: #E1E4E8">(image1, image2, kp1, remove_outliers: </span><span style="color: #79B8FF">bool</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">False</span><span style="color: #E1E4E8">):</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"""Tracks features using optical flow."""</span></span>
<span class="line"><span style="color: #E1E4E8">    kp2, status, _ </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> cv2.calcOpticalFlowPyrLK(image1, image2, kp1, </span><span style="color: #79B8FF">None</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> remove_outliers:</span></span>
<span class="line"><span style="color: #E1E4E8">        removed_ids </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> get_removed_pts_ids(kp2, image2, status)</span></span>
<span class="line"><span style="color: #E1E4E8">        kp1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.delete(kp1, removed_ids, </span><span style="color: #FFAB70">axis</span><span style="color: #F97583">=</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">        kp2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.delete(kp2, removed_ids, </span><span style="color: #FFAB70">axis</span><span style="color: #F97583">=</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> kp1, kp2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">kp1, kp2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> track_features(image1, image2, kp1, </span><span style="color: #FFAB70">remove_outliers</span><span style="color: #F97583">=</span><span style="color: #79B8FF">True</span><span style="color: #E1E4E8">)</span></span></code></pre></div>
</div>
<h2 id="fundamental-matrix"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#fundamental-matrix">#</a>Fundamental Matrix</h2>
<p>The fundamental matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>12</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>13</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>22</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>23</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>31</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>32</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>33</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">F = \begin{bmatrix}
    f_{11} &#x26; f_{12} &#x26; f_{13} \\
    f_{21} &#x26; f_{22} &#x26; f_{23} \\
    f_{31} &#x26; f_{32} &#x26; f_{33}
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">13</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">23</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">33</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span></span></span></span></span> is a <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span></span> matrix that encodes the relative orientation and position of the camera between <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">I_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span>.</p>
<h3 id="_8-point-algorithm"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#_8-point-algorithm">#</a>8-Point Algorithm</h3>
<p>To estimate <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span>, one of the solutions is <a href="https://www.cs.cmu.edu/~16385/s17/Slides/12.4_8Point_Algorithm.pdf" target="_blank" rel="noopener noreferrer">Hartley’s normalized 8-point algorithm</a>, where the constraint for <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> is:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center center center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup><msubsup><mi>x</mi><mi>i</mi><mn>1</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup><msubsup><mi>y</mi><mi>i</mi><mn>1</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup><msubsup><mi>x</mi><mi>i</mi><mn>1</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup><msubsup><mi>y</mi><mi>i</mi><mn>1</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>i</mi><mn>1</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>y</mi><mi>i</mi><mn>1</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup><msubsup><mi>x</mi><mi>i</mi><mn>8</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup><msubsup><mi>y</mi><mi>i</mi><mn>8</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup><msubsup><mi>x</mi><mi>i</mi><mn>8</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup><msubsup><mi>y</mi><mi>i</mi><mn>8</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>i</mi><mn>8</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>y</mi><mi>i</mi><mn>8</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>11</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>12</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>13</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>21</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>22</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>23</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>31</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>32</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>33</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mn>0</mn><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
    x_{i+1}^1 x_i^1 &#x26; x_{i+1}^1 y_i^1 &#x26; x_{i+1}^1 &#x26; y_{i+1}^1 x_i^1 &#x26; y_{i+1}^1 y_i^1 &#x26; y_{i+1}^1 &#x26; x_i^1 &#x26; y_i^1 &#x26; 1 \\
    \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26;  \vdots \\
    x_{i+1}^8 x_i^8 &#x26; x_{i+1}^8 y_i^8 &#x26; x_{i+1}^8 &#x26; y_{i+1}^8 x_i^8 &#x26; y_{i+1}^8 y_i^8 &#x26; y_{i+1}^8 &#x26; x_i^8 &#x26; y_i^8 &#x26; 1
\end{bmatrix}
\begin{bmatrix}
    f_{11} \\
    f_{12} \\
    f_{13} \\
    f_{21} \\
    f_{22} \\
    f_{23} \\
    f_{31} \\
    f_{32} \\
    f_{33}
\end{bmatrix}
= 0,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:10.8001em;vertical-align:-5.1501em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-4.35em;"><span class="pstrut" style="height:6.2em;"></span><span style="width:0.667em;height:4.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.200em" viewBox="0 0 667 4200"><path d="M403 1759 V84 H666 V0 H319 V1759 v600 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v600 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-4.35em;"><span class="pstrut" style="height:6.2em;"></span><span style="width:0.667em;height:4.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.200em" viewBox="0 0 667 4200"><path d="M347 1759 V0 H0 V84 H263 V1759 v600 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v600 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.6499em;"><span style="top:-7.6499em;"><span class="pstrut" style="height:12.8em;"></span><span style="width:0.667em;height:10.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="10.800em" viewBox="0 0 667 10800"><path d="M403 1759 V84 H666 V0 H319 V1759 v7200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v7200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.1501em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.65em;"><span style="top:-7.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-6.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">13</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">23</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-0.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:0.59em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:1.79em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">33</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.6499em;"><span style="top:-7.6499em;"><span class="pstrut" style="height:12.8em;"></span><span style="width:0.667em;height:10.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="10.800em" viewBox="0 0 667 10800"><path d="M347 1759 V0 H0 V84 H263 V1759 v7200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v7200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.1501em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">0</span><span class="mpunct">,</span></span></span></span></span></div>
<p>which can be answered by solving the linear least squares using Singular Value Decomposition (SVD). This algorithm requires 8 keypoint correspondences exists, where <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_i, y_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> are the coordinates of the 8 keypoints selected from <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_{i+1}, y_{i+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> are the coordinates of their corresponding keypoints in <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">K_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span>. The coordinates should be normalized by shifting them around the mean of the points and enclosing them at a distance of <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mn>2</mn></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1328em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span></span></span></span></span></span></span></span></span></span> from the new center.</p>
<p>Given 8 keypoint correspondences, the code for computing <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> is:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #D73A49">import</span><span style="color: #24292E"> numpy </span><span style="color: #D73A49">as</span><span style="color: #24292E"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">normalize</span><span style="color: #24292E">(pt: np.ndarray):</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #032F62">"""Normalizes the given set of points."""</span></span>
<span class="line"><span style="color: #24292E">    N </span><span style="color: #D73A49">=</span><span style="color: #24292E"> pt.shape[</span><span style="color: #005CC5">0</span><span style="color: #24292E">]</span></span>
<span class="line"><span style="color: #24292E">    mean </span><span style="color: #D73A49">=</span><span style="color: #24292E"> pt </span><span style="color: #D73A49">-</span><span style="color: #24292E"> np.mean(pt, </span><span style="color: #E36209">axis</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    scale </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.sum(np.square(pt)) </span><span style="color: #D73A49">/</span><span style="color: #24292E"> (</span><span style="color: #005CC5">2</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E"> N)</span></span>
<span class="line"><span style="color: #24292E">    scale </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.sqrt(</span><span style="color: #005CC5">1</span><span style="color: #24292E"> </span><span style="color: #D73A49">/</span><span style="color: #24292E"> scale)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> scale </span><span style="color: #D73A49">*</span><span style="color: #24292E"> mean, scale</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compute_fundamental_mat</span><span style="color: #24292E">(pt1: np.ndarray, pt2: np.ndarray)-> np.ndarray:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #032F62">"""Computes the fundamental matrix F using SVD."""</span></span>
<span class="line"><span style="color: #24292E">    N </span><span style="color: #D73A49">=</span><span style="color: #24292E"> pt1.shape[</span><span style="color: #005CC5">0</span><span style="color: #24292E">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    norm_pt1, scale1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> normalize(pt1)</span></span>
<span class="line"><span style="color: #24292E">    norm_pt2, scale2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> normalize(pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    T1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.array([</span></span>
<span class="line"><span style="color: #24292E">        [scale1, </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #D73A49">-</span><span style="color: #24292E"> scale1 </span><span style="color: #D73A49">*</span><span style="color: #24292E"> np.mean(pt1[:, </span><span style="color: #005CC5">0</span><span style="color: #24292E">])],</span></span>
<span class="line"><span style="color: #24292E">        [</span><span style="color: #005CC5">0</span><span style="color: #24292E">, scale1, </span><span style="color: #D73A49">-</span><span style="color: #24292E"> scale1 </span><span style="color: #D73A49">*</span><span style="color: #24292E"> np.mean(pt1[:, </span><span style="color: #005CC5">1</span><span style="color: #24292E">])],</span></span>
<span class="line"><span style="color: #24292E">        [</span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">]</span></span>
<span class="line"><span style="color: #24292E">    ])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    T2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.array([</span></span>
<span class="line"><span style="color: #24292E">        [scale2, </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #D73A49">-</span><span style="color: #24292E"> scale2 </span><span style="color: #D73A49">*</span><span style="color: #24292E"> np.mean(pt2[:, </span><span style="color: #005CC5">0</span><span style="color: #24292E">])],</span></span>
<span class="line"><span style="color: #24292E">        [</span><span style="color: #005CC5">0</span><span style="color: #24292E">, scale2, </span><span style="color: #D73A49">-</span><span style="color: #24292E"> scale2 </span><span style="color: #D73A49">*</span><span style="color: #24292E"> np.mean(pt2[:, </span><span style="color: #005CC5">1</span><span style="color: #24292E">])],</span></span>
<span class="line"><span style="color: #24292E">        [</span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">]</span></span>
<span class="line"><span style="color: #24292E">    ])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    A </span><span style="color: #D73A49">=</span><span style="color: #24292E"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> i </span><span style="color: #D73A49">in</span><span style="color: #24292E"> </span><span style="color: #005CC5">range</span><span style="color: #24292E">(N):</span></span>
<span class="line"><span style="color: #24292E">        x1, y1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> norm_pt1[i]</span></span>
<span class="line"><span style="color: #24292E">        x2, y2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> norm_pt2[i]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        a </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.array([x2 </span><span style="color: #D73A49">*</span><span style="color: #24292E"> x1, x2 </span><span style="color: #D73A49">*</span><span style="color: #24292E"> y1, x2, y2 </span><span style="color: #D73A49">*</span><span style="color: #24292E"> x1, y2 </span><span style="color: #D73A49">*</span><span style="color: #24292E"> y1, y2, x1, y1, </span><span style="color: #005CC5">1</span><span style="color: #24292E">])</span></span>
<span class="line"><span style="color: #24292E">        A.append(a)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    A </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.array(A)  </span><span style="color: #6A737D"># (N, 9)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    U1, S1, V1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.linalg.svd(A)</span></span>
<span class="line"><span style="color: #24292E">    F </span><span style="color: #D73A49">=</span><span style="color: #24292E"> V1[</span><span style="color: #D73A49">-</span><span style="color: #005CC5">1</span><span style="color: #24292E">,:].reshape(</span><span style="color: #005CC5">3</span><span style="color: #24292E">, </span><span style="color: #005CC5">3</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">    F </span><span style="color: #D73A49">/=</span><span style="color: #24292E"> F[</span><span style="color: #005CC5">2</span><span style="color: #24292E">, </span><span style="color: #005CC5">2</span><span style="color: #24292E">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    U2, S2, V2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.linalg.svd(F)</span></span>
<span class="line"><span style="color: #24292E">    S2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.diag(S2)</span></span>
<span class="line"><span style="color: #24292E">    S2[</span><span style="color: #D73A49">-</span><span style="color: #005CC5">1</span><span style="color: #24292E">] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    F </span><span style="color: #D73A49">=</span><span style="color: #24292E"> U2 </span><span style="color: #D73A49">@</span><span style="color: #24292E"> S2 </span><span style="color: #D73A49">@</span><span style="color: #24292E"> V2</span></span>
<span class="line"><span style="color: #24292E">    F </span><span style="color: #D73A49">=</span><span style="color: #24292E"> T2.T </span><span style="color: #D73A49">@</span><span style="color: #24292E"> F </span><span style="color: #D73A49">@</span><span style="color: #24292E"> T1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> F</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> numpy </span><span style="color: #F97583">as</span><span style="color: #E1E4E8"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">normalize</span><span style="color: #E1E4E8">(pt: np.ndarray):</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"""Normalizes the given set of points."""</span></span>
<span class="line"><span style="color: #E1E4E8">    N </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pt.shape[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">]</span></span>
<span class="line"><span style="color: #E1E4E8">    mean </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pt </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> np.mean(pt, </span><span style="color: #FFAB70">axis</span><span style="color: #F97583">=</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    scale </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.sum(np.square(pt)) </span><span style="color: #F97583">/</span><span style="color: #E1E4E8"> (</span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> N)</span></span>
<span class="line"><span style="color: #E1E4E8">    scale </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.sqrt(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">/</span><span style="color: #E1E4E8"> scale)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> scale </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> mean, scale</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">compute_fundamental_mat</span><span style="color: #E1E4E8">(pt1: np.ndarray, pt2: np.ndarray)-> np.ndarray:</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"""Computes the fundamental matrix F using SVD."""</span></span>
<span class="line"><span style="color: #E1E4E8">    N </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pt1.shape[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    norm_pt1, scale1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> normalize(pt1)</span></span>
<span class="line"><span style="color: #E1E4E8">    norm_pt2, scale2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> normalize(pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    T1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.array([</span></span>
<span class="line"><span style="color: #E1E4E8">        [scale1, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> scale1 </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> np.mean(pt1[:, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">])],</span></span>
<span class="line"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, scale1, </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> scale1 </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> np.mean(pt1[:, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">])],</span></span>
<span class="line"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">]</span></span>
<span class="line"><span style="color: #E1E4E8">    ])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    T2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.array([</span></span>
<span class="line"><span style="color: #E1E4E8">        [scale2, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> scale2 </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> np.mean(pt2[:, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">])],</span></span>
<span class="line"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, scale2, </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> scale2 </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> np.mean(pt2[:, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">])],</span></span>
<span class="line"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">]</span></span>
<span class="line"><span style="color: #E1E4E8">    ])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    A </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> i </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">range</span><span style="color: #E1E4E8">(N):</span></span>
<span class="line"><span style="color: #E1E4E8">        x1, y1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> norm_pt1[i]</span></span>
<span class="line"><span style="color: #E1E4E8">        x2, y2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> norm_pt2[i]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        a </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.array([x2 </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> x1, x2 </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> y1, x2, y2 </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> x1, y2 </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> y1, y2, x1, y1, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">])</span></span>
<span class="line"><span style="color: #E1E4E8">        A.append(a)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    A </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.array(A)  </span><span style="color: #6A737D"># (N, 9)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    U1, S1, V1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.linalg.svd(A)</span></span>
<span class="line"><span style="color: #E1E4E8">    F </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> V1[</span><span style="color: #F97583">-</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">,:].reshape(</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    F </span><span style="color: #F97583">/=</span><span style="color: #E1E4E8"> F[</span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    U2, S2, V2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.linalg.svd(F)</span></span>
<span class="line"><span style="color: #E1E4E8">    S2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.diag(S2)</span></span>
<span class="line"><span style="color: #E1E4E8">    S2[</span><span style="color: #F97583">-</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    F </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> U2 </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> S2 </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> V2</span></span>
<span class="line"><span style="color: #E1E4E8">    F </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> T2.T </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> F </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> T1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> F</span></span></code></pre></div>
</div>
<h3 id="ransac"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#ransac">#</a>RANSAC</h3>
<p>Our feature detection and tracking algorithms are not perfect, leading to several erroneous correspondences (outliers). Therefore, RANSAC is used to remove these outliers.</p>
<p>RANSAC is an iterative algorithm terminating after a fixed number of iterations. At every iteration, it works in the following way:</p>
<ul>
<li>Picks 8 keypoint correspondences from <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">K_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span></li>
<li>Computes <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> using Hartley’s 8-point algorithm mentioned above</li>
<li>Determines how many of all other keypoints are inliers</li>
</ul>
<p>Finally, the <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> with the maximum number of inliers will be used.</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compute_ransac_error</span><span style="color: #24292E">(F: np.ndarray, pt1: np.ndarray, pt2: np.ndarray):</span></span>
<span class="line"><span style="color: #24292E">    n </span><span style="color: #D73A49">=</span><span style="color: #24292E"> pt1.shape[</span><span style="color: #005CC5">0</span><span style="color: #24292E">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    p1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.hstack((pt1, np.ones((n, </span><span style="color: #005CC5">1</span><span style="color: #24292E">))))</span></span>
<span class="line"><span style="color: #24292E">    p2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.hstack((pt2, np.ones((n, </span><span style="color: #005CC5">1</span><span style="color: #24292E">))))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    e1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> p1 </span><span style="color: #D73A49">@</span><span style="color: #24292E"> F.T</span></span>
<span class="line"><span style="color: #24292E">    e2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> p2 </span><span style="color: #D73A49">@</span><span style="color: #24292E"> F</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    error </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.sum(e2 </span><span style="color: #D73A49">*</span><span style="color: #24292E"> p1, </span><span style="color: #E36209">axis</span><span style="color: #D73A49">=</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #E36209">keepdims</span><span style="color: #D73A49">=</span><span style="color: #005CC5">True</span><span style="color: #24292E">) </span><span style="color: #D73A49">**</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E"> </span><span style="color: #D73A49">/</span><span style="color: #24292E"> np.sum(np.hstack((e1[:, :</span><span style="color: #D73A49">-</span><span style="color: #005CC5">1</span><span style="color: #24292E">], e2[:, :</span><span style="color: #D73A49">-</span><span style="color: #005CC5">1</span><span style="color: #24292E">])) </span><span style="color: #D73A49">**</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E">, </span><span style="color: #E36209">axis</span><span style="color: #D73A49">=</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #E36209">keepdims</span><span style="color: #D73A49">=</span><span style="color: #005CC5">True</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> error</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">find_fundamental_mat</span><span style="color: #24292E">(</span></span>
<span class="line"><span style="color: #24292E">    pt1: np.ndarray, pt2: np.ndarray, threshold: </span><span style="color: #005CC5">float</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.05</span></span>
<span class="line"><span style="color: #24292E">)-> np.ndarray:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #032F62">"""Estimates the fundamental matrix using RANSAC."""</span></span>
<span class="line"><span style="color: #24292E">    max_inliers </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"><span style="color: #24292E">    best_F </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">None</span></span>
<span class="line"><span style="color: #24292E">    confidence </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.99</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    N </span><span style="color: #D73A49">=</span><span style="color: #24292E"> sys.maxsize</span></span>
<span class="line"><span style="color: #24292E">    count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">while</span><span style="color: #24292E"> N </span><span style="color: #D73A49">></span><span style="color: #24292E"> count:</span></span>
<span class="line"><span style="color: #24292E">        x, y </span><span style="color: #D73A49">=</span><span style="color: #24292E"> sample_eight_points(pt1, pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        F </span><span style="color: #D73A49">=</span><span style="color: #24292E"> compute_fundamental_mat(x, y)</span></span>
<span class="line"><span style="color: #24292E">        error </span><span style="color: #D73A49">=</span><span style="color: #24292E"> compute_ransac_error(F, pt1, pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        inliers </span><span style="color: #D73A49">=</span><span style="color: #24292E"> error </span><span style="color: #D73A49">&#x3C;=</span><span style="color: #24292E"> threshold</span></span>
<span class="line"><span style="color: #24292E">        n_inliers </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.sum(inliers)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> max_inliers </span><span style="color: #D73A49">&#x3C;</span><span style="color: #24292E"> np.sum(inliers):</span></span>
<span class="line"><span style="color: #24292E">            max_inliers </span><span style="color: #D73A49">=</span><span style="color: #24292E"> n_inliers</span></span>
<span class="line"><span style="color: #24292E">            best_F </span><span style="color: #D73A49">=</span><span style="color: #24292E"> F.copy()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        ratio </span><span style="color: #D73A49">=</span><span style="color: #24292E"> n_inliers </span><span style="color: #D73A49">/</span><span style="color: #24292E"> </span><span style="color: #005CC5">len</span><span style="color: #24292E">(pt1)</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> np.log(</span><span style="color: #005CC5">1</span><span style="color: #24292E"> </span><span style="color: #D73A49">-</span><span style="color: #24292E"> (ratio </span><span style="color: #D73A49">**</span><span style="color: #24292E"> </span><span style="color: #005CC5">8</span><span style="color: #24292E">)) </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">:</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">continue</span></span>
<span class="line"><span style="color: #24292E">        N </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.log(</span><span style="color: #005CC5">1</span><span style="color: #24292E"> </span><span style="color: #D73A49">-</span><span style="color: #24292E"> confidence) </span><span style="color: #D73A49">/</span><span style="color: #24292E"> np.log(</span><span style="color: #005CC5">1</span><span style="color: #24292E"> </span><span style="color: #D73A49">-</span><span style="color: #24292E"> (ratio </span><span style="color: #D73A49">**</span><span style="color: #24292E"> </span><span style="color: #005CC5">8</span><span style="color: #24292E">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        count </span><span style="color: #D73A49">+=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> best_F</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">F </span><span style="color: #D73A49">=</span><span style="color: #24292E"> find_fundamental_mat(kp1, kp2, </span><span style="color: #005CC5">0.05</span><span style="color: #24292E">)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">compute_ransac_error</span><span style="color: #E1E4E8">(F: np.ndarray, pt1: np.ndarray, pt2: np.ndarray):</span></span>
<span class="line"><span style="color: #E1E4E8">    n </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pt1.shape[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    p1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.hstack((pt1, np.ones((n, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">))))</span></span>
<span class="line"><span style="color: #E1E4E8">    p2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.hstack((pt2, np.ones((n, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">))))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    e1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> p1 </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> F.T</span></span>
<span class="line"><span style="color: #E1E4E8">    e2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> p2 </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> F</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    error </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.sum(e2 </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> p1, </span><span style="color: #FFAB70">axis</span><span style="color: #F97583">=</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">keepdims</span><span style="color: #F97583">=</span><span style="color: #79B8FF">True</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">/</span><span style="color: #E1E4E8"> np.sum(np.hstack((e1[:, :</span><span style="color: #F97583">-</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">], e2[:, :</span><span style="color: #F97583">-</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">])) </span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">axis</span><span style="color: #F97583">=</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">keepdims</span><span style="color: #F97583">=</span><span style="color: #79B8FF">True</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> error</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">find_fundamental_mat</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">    pt1: np.ndarray, pt2: np.ndarray, threshold: </span><span style="color: #79B8FF">float</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0.05</span></span>
<span class="line"><span style="color: #E1E4E8">)-> np.ndarray:</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"""Estimates the fundamental matrix using RANSAC."""</span></span>
<span class="line"><span style="color: #E1E4E8">    max_inliers </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #E1E4E8">    best_F </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">None</span></span>
<span class="line"><span style="color: #E1E4E8">    confidence </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0.99</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    N </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> sys.maxsize</span></span>
<span class="line"><span style="color: #E1E4E8">    count </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">while</span><span style="color: #E1E4E8"> N </span><span style="color: #F97583">></span><span style="color: #E1E4E8"> count:</span></span>
<span class="line"><span style="color: #E1E4E8">        x, y </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> sample_eight_points(pt1, pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        F </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> compute_fundamental_mat(x, y)</span></span>
<span class="line"><span style="color: #E1E4E8">        error </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> compute_ransac_error(F, pt1, pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        inliers </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> error </span><span style="color: #F97583">&#x3C;=</span><span style="color: #E1E4E8"> threshold</span></span>
<span class="line"><span style="color: #E1E4E8">        n_inliers </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.sum(inliers)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> max_inliers </span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8"> np.sum(inliers):</span></span>
<span class="line"><span style="color: #E1E4E8">            max_inliers </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> n_inliers</span></span>
<span class="line"><span style="color: #E1E4E8">            best_F </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> F.copy()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        ratio </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> n_inliers </span><span style="color: #F97583">/</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">len</span><span style="color: #E1E4E8">(pt1)</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> np.log(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> (ratio </span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">8</span><span style="color: #E1E4E8">)) </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">:</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">continue</span></span>
<span class="line"><span style="color: #E1E4E8">        N </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.log(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> confidence) </span><span style="color: #F97583">/</span><span style="color: #E1E4E8"> np.log(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> (ratio </span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">8</span><span style="color: #E1E4E8">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        count </span><span style="color: #F97583">+=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> best_F</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">F </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> find_fundamental_mat(kp1, kp2, </span><span style="color: #79B8FF">0.05</span><span style="color: #E1E4E8">)</span></span></code></pre></div>
</div>
<p>Then the problem is how to pick 8 keypoint correspondences (<code>sample_eight_points</code>). While Hartley’s 8-point algorithm samples them randomly, to make the algorithm more robust to outliers, we can use the way mentioned <a href="https://www.crcv.ucf.edu/wp-content/uploads/2019/03/Lecture-13-FundamentalMatrix.pdf" target="_blank" rel="noopener noreferrer">here</a> (page 39) instead: uniformly dividing a frame into an <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8 \times 8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">8</span></span></span></span></span> grid, then randomly selecting 8 grid cells and picking one pair of corresponding keypoints from each grid cell.</p>
<h2 id="essential-matrix"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#essential-matrix">#</a>Essential Matrix</h2>
<p>Essential matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> is another <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span></span> matrix. But unlike <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> assumes that the cameras obey the pinhole model. More specifically, given the camera calibration matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo>=</mo><msup><mi>K</mi><mi>T</mi></msup><mi>F</mi><mi>K</mi></mrow><annotation encoding="application/x-tex">E = K^T F K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>, which also can be solved using SVD.</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">find_essential_mat</span><span style="color: #24292E">(K: np.ndarray, F: np.ndarray)-> np.ndarray:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #032F62">"""Estimates the essential matrix."""</span></span>
<span class="line"><span style="color: #24292E">    E </span><span style="color: #D73A49">=</span><span style="color: #24292E"> K.T </span><span style="color: #D73A49">@</span><span style="color: #24292E"> F </span><span style="color: #D73A49">@</span><span style="color: #24292E"> K</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    U, S, V </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.linalg.svd(E)</span></span>
<span class="line highlighted"><span style="color: #24292E">    S </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.asarray([</span></span>
<span class="line highlighted"><span style="color: #24292E">        [</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">],</span></span>
<span class="line highlighted"><span style="color: #24292E">        [</span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">],</span></span>
<span class="line highlighted"><span style="color: #24292E">        [</span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">]</span></span>
<span class="line highlighted"><span style="color: #24292E">    ])</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color: #24292E">    E </span><span style="color: #D73A49">=</span><span style="color: #24292E"> U </span><span style="color: #D73A49">@</span><span style="color: #24292E"> S </span><span style="color: #D73A49">@</span><span style="color: #24292E"> V</span></span>
<span class="line"><span style="color: #24292E">    E </span><span style="color: #D73A49">=</span><span style="color: #24292E"> E </span><span style="color: #D73A49">/</span><span style="color: #24292E"> np.linalg.norm(E)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> E</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">E </span><span style="color: #D73A49">=</span><span style="color: #24292E"> find_essential_mat(K, F)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">find_essential_mat</span><span style="color: #E1E4E8">(K: np.ndarray, F: np.ndarray)-> np.ndarray:</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"""Estimates the essential matrix."""</span></span>
<span class="line"><span style="color: #E1E4E8">    E </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> K.T </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> F </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> K</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    U, S, V </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.linalg.svd(E)</span></span>
<span class="line highlighted"><span style="color: #E1E4E8">    S </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.asarray([</span></span>
<span class="line highlighted"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">],</span></span>
<span class="line highlighted"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">],</span></span>
<span class="line highlighted"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">]</span></span>
<span class="line highlighted"><span style="color: #E1E4E8">    ])</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color: #E1E4E8">    E </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> U </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> S </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> V</span></span>
<span class="line"><span style="color: #E1E4E8">    E </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> E </span><span style="color: #F97583">/</span><span style="color: #E1E4E8"> np.linalg.norm(E)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> E</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">E </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> find_essential_mat(K, F)</span></span></code></pre></div>
</div>
<p>Note that the singular values of <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> are not necessarily <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1, 1, 0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span> due to the noise in K. Thus <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> should be reconstructed with <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1, 1, 0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span> singular values:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo>=</mo><mi>U</mi><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><msup><mi>V</mi><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">E = U

\begin{bmatrix}
    1 &#x26; 0 &#x26; 0 \\
    0 &#x26; 1 &#x26; 0 \\
    0 &#x26; 0 &#x26; 0 \\
\end{bmatrix}

V^\top</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span></span></span></span></div>
<hr>
<p>Now we have successfully estimated the essential matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> manually, looks cool! However, this can also be done with the help of OpenCV, and all you need is one line:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #24292E">E, mask </span><span style="color: #D73A49">=</span><span style="color: #24292E"> cv2.findEssentialMat(kp2, kp1, K, cv2.</span><span style="color: #005CC5">RANSAC</span><span style="color: #24292E">, </span><span style="color: #005CC5">0.999</span><span style="color: #24292E">, </span><span style="color: #005CC5">0.3</span><span style="color: #24292E">, </span><span style="color: #005CC5">None</span><span style="color: #24292E">)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #E1E4E8">E, mask </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> cv2.findEssentialMat(kp2, kp1, K, cv2.</span><span style="color: #79B8FF">RANSAC</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0.999</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0.3</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">None</span><span style="color: #E1E4E8">)</span></span></code></pre></div>
</div>
<p>OpenCV uses <a href="https://www-users.cse.umn.edu/~hspark/CSci5980/nister.pdf" target="_blank" rel="noopener noreferrer">Nistér’s 5-point algorithm</a>, a more recent approach that is shown to give better results, to compute <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span>. It requires the minimum number of keypoints possible since <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> has only 5 degrees of freedom (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> has 7 degrees of freedom, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> has only 5 as it takes camera parameters into account).</p>
<h2 id="camera-pose"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#camera-pose">#</a>Camera Pose</h2>
<p>Just follow <a href="https://cmsc426.github.io/sfm/#essential" target="_blank" rel="noopener noreferrer">here</a> to recover the camera rotation matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and translation vector <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">t_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> from <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span>.</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">linear_triangulation</span><span style="color: #24292E">(</span></span>
<span class="line"><span style="color: #24292E">    T1: np.ndarray,</span></span>
<span class="line"><span style="color: #24292E">    R1: np.ndarray,</span></span>
<span class="line"><span style="color: #24292E">    T2: np.ndarray,</span></span>
<span class="line"><span style="color: #24292E">    R2: np.ndarray,</span></span>
<span class="line"><span style="color: #24292E">    pt1: np.ndarray,</span></span>
<span class="line"><span style="color: #24292E">    pt2: np.ndarray,</span></span>
<span class="line"><span style="color: #24292E">    K: np.ndarray,</span></span>
<span class="line"><span style="color: #24292E">)-> np.ndarray:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #032F62">"""Linear triangulation."""</span></span>
<span class="line"><span style="color: #24292E">    P1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> K </span><span style="color: #D73A49">@</span><span style="color: #24292E"> np.hstack((R1, </span><span style="color: #D73A49">-</span><span style="color: #24292E">R1 </span><span style="color: #D73A49">@</span><span style="color: #24292E"> T1))</span></span>
<span class="line"><span style="color: #24292E">    P2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> K </span><span style="color: #D73A49">@</span><span style="color: #24292E"> np.hstack((R2, </span><span style="color: #D73A49">-</span><span style="color: #24292E">R2 </span><span style="color: #D73A49">@</span><span style="color: #24292E"> T2))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    X </span><span style="color: #D73A49">=</span><span style="color: #24292E"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> i </span><span style="color: #D73A49">in</span><span style="color: #24292E"> </span><span style="color: #005CC5">range</span><span style="color: #24292E">(</span><span style="color: #005CC5">len</span><span style="color: #24292E">(pt1)):</span></span>
<span class="line"><span style="color: #24292E">        x1, x2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> pt1[i], pt2[i]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        A1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> x1[</span><span style="color: #005CC5">0</span><span style="color: #24292E">] </span><span style="color: #D73A49">*</span><span style="color: #24292E"> P1[</span><span style="color: #005CC5">2</span><span style="color: #24292E">, :] </span><span style="color: #D73A49">-</span><span style="color: #24292E"> P1[</span><span style="color: #005CC5">0</span><span style="color: #24292E">, :]</span></span>
<span class="line"><span style="color: #24292E">        A2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> x1[</span><span style="color: #005CC5">1</span><span style="color: #24292E">] </span><span style="color: #D73A49">*</span><span style="color: #24292E"> P1[</span><span style="color: #005CC5">2</span><span style="color: #24292E">, :] </span><span style="color: #D73A49">-</span><span style="color: #24292E"> P1[</span><span style="color: #005CC5">1</span><span style="color: #24292E">, :]</span></span>
<span class="line"><span style="color: #24292E">        A3 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> x2[</span><span style="color: #005CC5">0</span><span style="color: #24292E">] </span><span style="color: #D73A49">*</span><span style="color: #24292E"> P2[</span><span style="color: #005CC5">2</span><span style="color: #24292E">, :] </span><span style="color: #D73A49">-</span><span style="color: #24292E"> P2[</span><span style="color: #005CC5">0</span><span style="color: #24292E">, :]</span></span>
<span class="line"><span style="color: #24292E">        A4 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> x2[</span><span style="color: #005CC5">1</span><span style="color: #24292E">] </span><span style="color: #D73A49">*</span><span style="color: #24292E"> P2[</span><span style="color: #005CC5">2</span><span style="color: #24292E">, :] </span><span style="color: #D73A49">-</span><span style="color: #24292E"> P2[</span><span style="color: #005CC5">1</span><span style="color: #24292E">, :]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        A </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.asarray([A1, A2, A3, A4])</span></span>
<span class="line"><span style="color: #24292E">        U, S, V </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.linalg.svd(A)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        V </span><span style="color: #D73A49">=</span><span style="color: #24292E"> V[</span><span style="color: #005CC5">3</span><span style="color: #24292E">]</span></span>
<span class="line"><span style="color: #24292E">        V </span><span style="color: #D73A49">=</span><span style="color: #24292E"> V </span><span style="color: #D73A49">/</span><span style="color: #24292E"> V[</span><span style="color: #D73A49">-</span><span style="color: #005CC5">1</span><span style="color: #24292E">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        X.append(V)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> np.asarray(X)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">def</span><span style="color: #24292E"> </span><span style="color: #6F42C1">recover_pose</span><span style="color: #24292E">(E: np.ndarray, pt1, pt2, K: np.ndarray):</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #032F62">"""Recovers the camera pose."""</span></span>
<span class="line"><span style="color: #24292E">    W </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.asarray([</span></span>
<span class="line"><span style="color: #24292E">        [</span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #D73A49">-</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">],</span></span>
<span class="line"><span style="color: #24292E">        [</span><span style="color: #005CC5">1</span><span style="color: #24292E">,  </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">],</span></span>
<span class="line"><span style="color: #24292E">        [</span><span style="color: #005CC5">0</span><span style="color: #24292E">,  </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">]</span></span>
<span class="line"><span style="color: #24292E">    ])</span></span>
<span class="line"><span style="color: #24292E">    U, S, V </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.linalg.svd(E)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    poses </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #032F62">"T1"</span><span style="color: #24292E">:  U[:, </span><span style="color: #005CC5">2</span><span style="color: #24292E">].reshape(</span><span style="color: #005CC5">3</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">),</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #032F62">"T2"</span><span style="color: #24292E">: </span><span style="color: #D73A49">-</span><span style="color: #24292E">U[:, </span><span style="color: #005CC5">2</span><span style="color: #24292E">].reshape(</span><span style="color: #005CC5">3</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">),</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #032F62">"T3"</span><span style="color: #24292E">:  U[:, </span><span style="color: #005CC5">2</span><span style="color: #24292E">].reshape(</span><span style="color: #005CC5">3</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">),</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #032F62">"T4"</span><span style="color: #24292E">: </span><span style="color: #D73A49">-</span><span style="color: #24292E">U[:, </span><span style="color: #005CC5">2</span><span style="color: #24292E">].reshape(</span><span style="color: #005CC5">3</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">),</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #032F62">"R1"</span><span style="color: #24292E">:  U </span><span style="color: #D73A49">@</span><span style="color: #24292E"> W   </span><span style="color: #D73A49">@</span><span style="color: #24292E"> V,</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #032F62">"R2"</span><span style="color: #24292E">:  U </span><span style="color: #D73A49">@</span><span style="color: #24292E"> W   </span><span style="color: #D73A49">@</span><span style="color: #24292E"> V,</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #032F62">"R3"</span><span style="color: #24292E">:  U </span><span style="color: #D73A49">@</span><span style="color: #24292E"> W.T </span><span style="color: #D73A49">@</span><span style="color: #24292E"> V,</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #032F62">"R4"</span><span style="color: #24292E">:  U </span><span style="color: #D73A49">@</span><span style="color: #24292E"> W.T </span><span style="color: #D73A49">@</span><span style="color: #24292E"> V</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> i </span><span style="color: #D73A49">in</span><span style="color: #24292E"> </span><span style="color: #005CC5">range</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">5</span><span style="color: #24292E">):</span></span>
<span class="line"><span style="color: #24292E">        T, R </span><span style="color: #D73A49">=</span><span style="color: #24292E"> poses[</span><span style="color: #032F62">"T"</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">str</span><span style="color: #24292E">(i)], poses[</span><span style="color: #032F62">"R"</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">str</span><span style="color: #24292E">(i)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> np.linalg.det(R) </span><span style="color: #D73A49">&#x3C;</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">:</span></span>
<span class="line"><span style="color: #24292E">            T </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">-</span><span style="color: #24292E">T</span></span>
<span class="line"><span style="color: #24292E">            R </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">-</span><span style="color: #24292E">R</span></span>
<span class="line"><span style="color: #24292E">            poses[</span><span style="color: #032F62">"T"</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">str</span><span style="color: #24292E">(i)], poses[</span><span style="color: #032F62">"R"</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">str</span><span style="color: #24292E">(i)] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> T, R</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        I </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.identity(</span><span style="color: #005CC5">3</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">        M </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.hstack((I, T.reshape(</span><span style="color: #005CC5">3</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">)))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        poses[</span><span style="color: #032F62">"P"</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">str</span><span style="color: #24292E">(i)] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> K </span><span style="color: #D73A49">@</span><span style="color: #24292E"> R </span><span style="color: #D73A49">@</span><span style="color: #24292E"> M</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    max_Z, rt_idx </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> i </span><span style="color: #D73A49">in</span><span style="color: #24292E"> </span><span style="color: #005CC5">range</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">5</span><span style="color: #24292E">):</span></span>
<span class="line"><span style="color: #24292E">        T1, R1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> poses[</span><span style="color: #032F62">"T"</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">str</span><span style="color: #24292E">(i)], poses[</span><span style="color: #032F62">"R"</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">str</span><span style="color: #24292E">(i)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6A737D"># ---------------------</span></span>
<span class="line"><span style="color: #24292E">        T2, R2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.asarray([[</span><span style="color: #005CC5">0</span><span style="color: #24292E">],[</span><span style="color: #005CC5">0</span><span style="color: #24292E">],[</span><span style="color: #005CC5">0</span><span style="color: #24292E">]]), np.identity(</span><span style="color: #005CC5">3</span><span style="color: #24292E">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        X </span><span style="color: #D73A49">=</span><span style="color: #24292E"> linear_triangulation(T2, R2, T1, R1, pt1, pt2, K)</span></span>
<span class="line"><span style="color: #24292E">        Z </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">for</span><span style="color: #24292E"> j </span><span style="color: #D73A49">in</span><span style="color: #24292E"> </span><span style="color: #005CC5">range</span><span style="color: #24292E">(X.shape[</span><span style="color: #005CC5">0</span><span style="color: #24292E">]):</span></span>
<span class="line"><span style="color: #24292E">            x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> X[j, :].reshape(</span><span style="color: #D73A49">-</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">if</span><span style="color: #24292E"> R1[</span><span style="color: #005CC5">2</span><span style="color: #24292E">] </span><span style="color: #D73A49">@</span><span style="color: #24292E"> np.subtract(x[</span><span style="color: #005CC5">0</span><span style="color: #24292E">:</span><span style="color: #005CC5">3</span><span style="color: #24292E">], T1) </span><span style="color: #D73A49">></span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E"> </span><span style="color: #D73A49">and</span><span style="color: #24292E"> x[</span><span style="color: #005CC5">2</span><span style="color: #24292E">] </span><span style="color: #D73A49">></span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">:</span></span>
<span class="line"><span style="color: #24292E">                Z </span><span style="color: #D73A49">+=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6A737D"># ---------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> max_Z </span><span style="color: #D73A49">&#x3C;</span><span style="color: #24292E"> Z:</span></span>
<span class="line"><span style="color: #24292E">            max_Z, rt_idx </span><span style="color: #D73A49">=</span><span style="color: #24292E"> Z, </span><span style="color: #005CC5">str</span><span style="color: #24292E">(i)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    cur_T, cur_R </span><span style="color: #D73A49">=</span><span style="color: #24292E"> poses[</span><span style="color: #032F62">"T"</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> rt_idx], poses[</span><span style="color: #032F62">"R"</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> rt_idx]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> cur_T[</span><span style="color: #005CC5">2</span><span style="color: #24292E">] </span><span style="color: #D73A49">&#x3C;</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">:</span></span>
<span class="line"><span style="color: #24292E">        cur_T </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">-</span><span style="color: #24292E">cur_T</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> cur_T, cur_R</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">cur_T, cur_R </span><span style="color: #D73A49">=</span><span style="color: #24292E"> recover_pose(E, kp1, kp2, K)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">linear_triangulation</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">    T1: np.ndarray,</span></span>
<span class="line"><span style="color: #E1E4E8">    R1: np.ndarray,</span></span>
<span class="line"><span style="color: #E1E4E8">    T2: np.ndarray,</span></span>
<span class="line"><span style="color: #E1E4E8">    R2: np.ndarray,</span></span>
<span class="line"><span style="color: #E1E4E8">    pt1: np.ndarray,</span></span>
<span class="line"><span style="color: #E1E4E8">    pt2: np.ndarray,</span></span>
<span class="line"><span style="color: #E1E4E8">    K: np.ndarray,</span></span>
<span class="line"><span style="color: #E1E4E8">)-> np.ndarray:</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"""Linear triangulation."""</span></span>
<span class="line"><span style="color: #E1E4E8">    P1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> K </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> np.hstack((R1, </span><span style="color: #F97583">-</span><span style="color: #E1E4E8">R1 </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> T1))</span></span>
<span class="line"><span style="color: #E1E4E8">    P2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> K </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> np.hstack((R2, </span><span style="color: #F97583">-</span><span style="color: #E1E4E8">R2 </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> T2))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    X </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> i </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">range</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">len</span><span style="color: #E1E4E8">(pt1)):</span></span>
<span class="line"><span style="color: #E1E4E8">        x1, x2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pt1[i], pt2[i]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        A1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> x1[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> P1[</span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">, :] </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> P1[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, :]</span></span>
<span class="line"><span style="color: #E1E4E8">        A2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> x1[</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> P1[</span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">, :] </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> P1[</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, :]</span></span>
<span class="line"><span style="color: #E1E4E8">        A3 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> x2[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> P2[</span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">, :] </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> P2[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, :]</span></span>
<span class="line"><span style="color: #E1E4E8">        A4 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> x2[</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> P2[</span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">, :] </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> P2[</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, :]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        A </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.asarray([A1, A2, A3, A4])</span></span>
<span class="line"><span style="color: #E1E4E8">        U, S, V </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.linalg.svd(A)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        V </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> V[</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">]</span></span>
<span class="line"><span style="color: #E1E4E8">        V </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> V </span><span style="color: #F97583">/</span><span style="color: #E1E4E8"> V[</span><span style="color: #F97583">-</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        X.append(V)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> np.asarray(X)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">recover_pose</span><span style="color: #E1E4E8">(E: np.ndarray, pt1, pt2, K: np.ndarray):</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"""Recovers the camera pose."""</span></span>
<span class="line"><span style="color: #E1E4E8">    W </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.asarray([</span></span>
<span class="line"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">-</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">],</span></span>
<span class="line"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">,  </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">],</span></span>
<span class="line"><span style="color: #E1E4E8">        [</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">,  </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">]</span></span>
<span class="line"><span style="color: #E1E4E8">    ])</span></span>
<span class="line"><span style="color: #E1E4E8">    U, S, V </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.linalg.svd(E)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    poses </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"T1"</span><span style="color: #E1E4E8">:  U[:, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">].reshape(</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">),</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"T2"</span><span style="color: #E1E4E8">: </span><span style="color: #F97583">-</span><span style="color: #E1E4E8">U[:, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">].reshape(</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">),</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"T3"</span><span style="color: #E1E4E8">:  U[:, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">].reshape(</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">),</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"T4"</span><span style="color: #E1E4E8">: </span><span style="color: #F97583">-</span><span style="color: #E1E4E8">U[:, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">].reshape(</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">),</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"R1"</span><span style="color: #E1E4E8">:  U </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> W   </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> V,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"R2"</span><span style="color: #E1E4E8">:  U </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> W   </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> V,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"R3"</span><span style="color: #E1E4E8">:  U </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> W.T </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> V,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"R4"</span><span style="color: #E1E4E8">:  U </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> W.T </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> V</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> i </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">range</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">5</span><span style="color: #E1E4E8">):</span></span>
<span class="line"><span style="color: #E1E4E8">        T, R </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> poses[</span><span style="color: #9ECBFF">"T"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">str</span><span style="color: #E1E4E8">(i)], poses[</span><span style="color: #9ECBFF">"R"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">str</span><span style="color: #E1E4E8">(i)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> np.linalg.det(R) </span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">:</span></span>
<span class="line"><span style="color: #E1E4E8">            T </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-</span><span style="color: #E1E4E8">T</span></span>
<span class="line"><span style="color: #E1E4E8">            R </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-</span><span style="color: #E1E4E8">R</span></span>
<span class="line"><span style="color: #E1E4E8">            poses[</span><span style="color: #9ECBFF">"T"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">str</span><span style="color: #E1E4E8">(i)], poses[</span><span style="color: #9ECBFF">"R"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">str</span><span style="color: #E1E4E8">(i)] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> T, R</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        I </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.identity(</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">        M </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.hstack((I, T.reshape(</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        poses[</span><span style="color: #9ECBFF">"P"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">str</span><span style="color: #E1E4E8">(i)] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> K </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> R </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> M</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    max_Z, rt_idx </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> i </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">range</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">5</span><span style="color: #E1E4E8">):</span></span>
<span class="line"><span style="color: #E1E4E8">        T1, R1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> poses[</span><span style="color: #9ECBFF">"T"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">str</span><span style="color: #E1E4E8">(i)], poses[</span><span style="color: #9ECBFF">"R"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">str</span><span style="color: #E1E4E8">(i)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #6A737D"># ---------------------</span></span>
<span class="line"><span style="color: #E1E4E8">        T2, R2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.asarray([[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">],[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">],[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">]]), np.identity(</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        X </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> linear_triangulation(T2, R2, T1, R1, pt1, pt2, K)</span></span>
<span class="line"><span style="color: #E1E4E8">        Z </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> j </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">range</span><span style="color: #E1E4E8">(X.shape[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">]):</span></span>
<span class="line"><span style="color: #E1E4E8">            x </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> X[j, :].reshape(</span><span style="color: #F97583">-</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> R1[</span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> np.subtract(x[</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">:</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">], T1) </span><span style="color: #F97583">></span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">and</span><span style="color: #E1E4E8"> x[</span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">></span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">:</span></span>
<span class="line"><span style="color: #E1E4E8">                Z </span><span style="color: #F97583">+=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #6A737D"># ---------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> max_Z </span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8"> Z:</span></span>
<span class="line"><span style="color: #E1E4E8">            max_Z, rt_idx </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> Z, </span><span style="color: #79B8FF">str</span><span style="color: #E1E4E8">(i)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    cur_T, cur_R </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> poses[</span><span style="color: #9ECBFF">"T"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> rt_idx], poses[</span><span style="color: #9ECBFF">"R"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> rt_idx]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> cur_T[</span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">:</span></span>
<span class="line"><span style="color: #E1E4E8">        cur_T </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-</span><span style="color: #E1E4E8">cur_T</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> cur_T, cur_R</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">cur_T, cur_R </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> recover_pose(E, kp1, kp2, K)</span></span></code></pre></div>
</div>
<hr>
<p>Again, here is how to implement it in OpenCV:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #24292E">kp1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.array([pt </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (idx, pt) </span><span style="color: #D73A49">in</span><span style="color: #24292E"> </span><span style="color: #005CC5">enumerate</span><span style="color: #24292E">(kp1) </span><span style="color: #D73A49">if</span><span style="color: #24292E"> mask[idx] </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">])</span></span>
<span class="line"><span style="color: #24292E">kp2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.array([pt </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (idx, pt) </span><span style="color: #D73A49">in</span><span style="color: #24292E"> </span><span style="color: #005CC5">enumerate</span><span style="color: #24292E">(kp2) </span><span style="color: #D73A49">if</span><span style="color: #24292E"> mask[idx] </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">])</span></span>
<span class="line"><span style="color: #24292E">_, cur_R, cur_t, _ </span><span style="color: #D73A49">=</span><span style="color: #24292E"> cv2.recoverPose(E, kp2, kp1, K)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #E1E4E8">kp1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.array([pt </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> (idx, pt) </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">enumerate</span><span style="color: #E1E4E8">(kp1) </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> mask[idx] </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">])</span></span>
<span class="line"><span style="color: #E1E4E8">kp2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.array([pt </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> (idx, pt) </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">enumerate</span><span style="color: #E1E4E8">(kp2) </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> mask[idx] </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">])</span></span>
<span class="line"><span style="color: #E1E4E8">_, cur_R, cur_t, _ </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> cv2.recoverPose(E, kp2, kp1, K)</span></span></code></pre></div>
</div>
<h2 id="trajectory"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#trajectory">#</a>Trajectory</h2>
<p>Denote the pose of the camera as <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span>, which should be initialized as:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #24292E">R, T </span><span style="color: #D73A49">=</span><span style="color: #24292E"> np.identity(</span><span style="color: #005CC5">3</span><span style="color: #24292E">), np.zeros((</span><span style="color: #005CC5">3</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">))</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #E1E4E8">R, T </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> np.identity(</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">), np.zeros((</span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">))</span></span></code></pre></div>
</div>
<p>We can update the trajectory of the camera by:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>t</mi><mo>=</mo><mi>t</mi><mo>+</mo><mi>R</mi><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">t = t + R t_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6984em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo>=</mo><msub><mi>R</mi><mi>i</mi></msub><mi>R</mi></mrow><annotation encoding="application/x-tex">R = R_i R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span></div>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #24292E">T </span><span style="color: #D73A49">=</span><span style="color: #24292E"> T </span><span style="color: #D73A49">+</span><span style="color: #24292E"> R </span><span style="color: #D73A49">@</span><span style="color: #24292E"> cur_T</span></span>
<span class="line"><span style="color: #24292E">R </span><span style="color: #D73A49">=</span><span style="color: #24292E"> cur_R </span><span style="color: #D73A49">@</span><span style="color: #24292E"> R</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #E1E4E8">T </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> T </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> R </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> cur_T</span></span>
<span class="line"><span style="color: #E1E4E8">R </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> cur_R </span><span style="color: #F97583">@</span><span style="color: #E1E4E8"> R</span></span></code></pre></div>
</div>
<p>That’s it! We can now move to the next pair of frames <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>2</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(I_{i+1}, I_{i+2})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> and repeat from <a href="#feature-detection">here</a>.</p>
<p>Of course, there are many details and optimizations (e.g. bundle adjustment) that can be added to improve the accuracy and performance of the VO system, but this should give a good starting point for building a monocular VO system.</p>
<h2 id="references"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#references">#</a>References</h2>
<ul>
<li><a href="https://cmsc426.github.io/sfm/" target="_blank" rel="noopener noreferrer">Structure from Motion (University of Maryland)</a></li>
<li><a href="https://www.cs.cmu.edu/~16385/s17/Slides/12.4_8Point_Algorithm.pdf" target="_blank" rel="noopener noreferrer">The 8-point algorithm (Carnegie Mellon University)</a></li>
<li><a href="https://www.crcv.ucf.edu/wp-content/uploads/2019/03/Lecture-13-FundamentalMatrix.pdf" target="_blank" rel="noopener noreferrer">Fundamental Matrix (University of Central Florida)</a></li>
<li><a href="https://www-users.cse.umn.edu/~hspark/CSci5980/nister.pdf" target="_blank" rel="noopener noreferrer">An Efficient Solution to the Five-Point Relative Pose Problem</a>. <em>David Nistér</em>. IEEE Transactions on Pattern Analysis and Machine Intelligence, 2004.</li>
<li><a href="https://avisingh599.github.io/vision/monocular-vo/" target="_blank" rel="noopener noreferrer">Monocular Visual Odometry using OpenCV</a></li>
</ul>
  </div>

  <div class="grid md:grid-cols-2 text-[0.95em] astro-GVPN4U4B">
    <a href="https://github.com/Renovamen/renovamen.github.io/edit/main/src/content/blog/2022-12-19-monocular-visual-odometry.md" title="Edit link" target="_blank" rel="noopener noreferrer" class="hover:underline astro-GVPN4U4B">
      <span class="i-tabler:edit w-4.5 h-4.5 align-text-top astro-GVPN4U4B"></span>
      Edit this page on GitHub
    </a>
    <span md:text-right text-c-light class="astro-GVPN4U4B">
          <span class="i-ic:round-update w-4.5 h-4.5 astro-GVPN4U4B"></span>
          Last updated:
          3/7/2023, 2:57:21 PM
        </span>
  </div>

  <div class="mt-3 pt-3 text-[0.95em] astro-GVPN4U4B" grid="~ md:cols-2" border="t c">
        <span class="prev astro-GVPN4U4B">
          <a href="/posts/2022-06-28-new-mac" class="!text-c astro-GVPN4U4B">
              What to install after getting a new Macbook
            </a>
        </span>
        <span class="next text-right astro-GVPN4U4B">
          <a href="/posts/2022-12-29-natural-gradient-decent" class="!text-c astro-GVPN4U4B">
              Natural Gradient Decent
            </a>
        </span>
      </div><div mt-20 class="astro-GVPN4U4B">
    <script>(()=>{var r=(s,c,i)=>{let o=async()=>{await(await s())()},n=new IntersectionObserver(e=>{for(let t of e)if(t.isIntersecting){n.disconnect(),o();break}});for(let e=0;e<i.children.length;e++){let t=i.children[e];n.observe(t)}};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();</script><astro-island uid="2ofSuY" data-solid-render-id="s1" component-url="/_astro/Giscus.fe86f833.js" component-export="default" renderer-url="/_astro/client.6684d98a.js" props="{&quot;class&quot;:[0,&quot;astro-GVPN4U4B&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;Giscus&quot;,&quot;value&quot;:true}" await-children=""><div data-hk="s10-0" class="giscus"></div></astro-island>
  </div>

        </div>
      </div>
      <footer class="max-w-content w-full hstack justify-between font-ui mx-auto mt-20 astro-SZ7XMLTE" text="xs lg:sm">
  <span text-c-lighter class="astro-SZ7XMLTE">
    <span class="astro-SZ7XMLTE">© Xiaohan Zou 2023</span>
    <span lt-sm:hidden class="astro-SZ7XMLTE">· A dragon lost in human world</span>
  </span>
  <span hstack space-x-3 class="astro-SZ7XMLTE">
    <a class="footer-item astro-SZ7XMLTE" href="https://github.com/Renovamen/renovamen.github.io" title="Source code" target="_blank" rel="noopener noreferrer">
      <div i-lucide:code-2 class="astro-SZ7XMLTE"></div>
      <span lt-sm:hidden class="astro-SZ7XMLTE">Code</span>
    </a>
    <a class="footer-item astro-SZ7XMLTE" href="/rss.xml" title="RSS" target="_blank" rel="noopener noreferrer">
      <div i-heroicons:rss-20-solid class="astro-SZ7XMLTE"></div>
      <span lt-sm:hidden class="astro-SZ7XMLTE">RSS</span>
    </a>
    <a class="footer-item astro-SZ7XMLTE" href="/sitemap-index.xml" title="Sitemap" target="_blank" rel="noopener noreferrer">
      <div i-bx:map-alt class="astro-SZ7XMLTE"></div>
      <span lt-sm:hidden class="astro-SZ7XMLTE">Sitemap</span>
    </a>
  </span>
</footer>
    </main>
  </body></html>

