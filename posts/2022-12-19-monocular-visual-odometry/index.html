<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link rel="canonical" href="https://zxh.io/posts/2022-12-19-monocular-visual-odometry/">
    <meta name="generator" content="Astro v2.0.17">
    <meta name="msapplication-TileColor" content="#ffffff">

    <!-- General Meta Tags -->
    <title>Implement Monocular Visual Odometry - Xiaohan Zou</title>
    <meta name="title" content="Implement Monocular Visual Odometry - Xiaohan Zou">
    <meta name="description" content="A dragon lost in human world.">
    <meta name="author" content="Xiaohan Zou">

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content="Implement Monocular Visual Odometry - Xiaohan Zou">
    <meta property="og:description" content="A dragon lost in human world.">
    <meta property="og:url" content="https://zxh.io/posts/2022-12-19-monocular-visual-odometry/">

    <!-- Twitter -->
    <meta property="twitter:title" content="Implement Monocular Visual Odometry - Xiaohan Zou">
    <meta property="twitter:description" content="A dragon lost in human world.">
    <meta property="twitter:url" content="https://zxh.io/posts/2022-12-19-monocular-visual-odometry/">

    
  <link rel="stylesheet" href="/_astro/404.48f1b9b6.css" />
<link rel="stylesheet" href="/_astro/_slug_.6ea23a96.css" />
<link rel="stylesheet" href="/_astro/index.782dd28f.css" />
<link rel="stylesheet" href="/_astro/index.4f915957.css" /><script type="module" src="/_astro/hoisted.a42a77e7.js"></script></head>

  <body class="font-sans">
    <main class="flex flex-col min-h-full text-c px-4 pt-24 pb-6">
      <style>astro-island,astro-slot{display:contents}</style><script>(self.Astro=self.Astro||{}).only=t=>{(async()=>await(await t())())()},window.dispatchEvent(new Event("astro:only"));var l;{const c={0:t=>t,1:t=>JSON.parse(t,o),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(JSON.parse(t,o)),5:t=>new Set(JSON.parse(t,o)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(JSON.parse(t)),9:t=>new Uint16Array(JSON.parse(t)),10:t=>new Uint32Array(JSON.parse(t))},o=(t,s)=>{if(t===""||!Array.isArray(s))return s;const[e,n]=s;return e in c?c[e](n):void 0};customElements.get("astro-island")||customElements.define("astro-island",(l=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=()=>{if(!this.hydrator||this.parentElement&&this.parentElement.closest("astro-island[ssr]"))return;const s=this.querySelectorAll("astro-slot"),e={},n=this.querySelectorAll("template[data-astro-template]");for(const r of n){const i=r.closest(this.tagName);!i||!i.isSameNode(this)||(e[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(const r of s){const i=r.closest(this.tagName);!i||!i.isSameNode(this)||(e[r.getAttribute("name")||"default"]=r.innerHTML)}const a=this.hasAttribute("props")?JSON.parse(this.getAttribute("props"),o):{};this.hydrator(this)(this.Component,a,e,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),window.removeEventListener("astro:hydrate",this.hydrate),window.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((s,e)=>{e.disconnect(),this.childrenConnectedCallback()}).observe(this,{childList:!0})}async childrenConnectedCallback(){window.addEventListener("astro:hydrate",this.hydrate);let s=this.getAttribute("before-hydration-url");s&&await import(s),this.start()}start(){const s=JSON.parse(this.getAttribute("opts")),e=this.getAttribute("client");if(Astro[e]===void 0){window.addEventListener(`astro:${e}`,()=>this.start(),{once:!0});return}Astro[e](async()=>{const n=this.getAttribute("renderer-url"),[a,{default:r}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(const d of i.split("."))this.Component=this.Component[d]}return this.hydrator=r,this.hydrate},s,this)}attributeChangedCallback(){this.hydrator&&this.hydrate()}},l.observedAttributes=["props"],l))}</script><astro-island uid="Z2mY7SW" component-url="/_astro/Navbar.0110276f.js" component-export="default" renderer-url="/_astro/client.7b0202fb.js" props="{&quot;activePage&quot;:[0,&quot;posts&quot;]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;Navbar&quot;,&quot;value&quot;:true}" await-children=""><template data-astro-template><astro-island uid="Z1mucHd" component-url="/_astro/ToggleToc.3174b8ea.js" component-export="default" renderer-url="/_astro/client.7b0202fb.js" props="{&quot;slot&quot;:[0,&quot;navbar&quot;],&quot;class&quot;:[0,&quot;astro-GVPN4U4B&quot;]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;ToggleToc&quot;,&quot;value&quot;:true}"></astro-island></template></astro-island>
      <div class="flex-1 mb-6">
        <div prose-lg mx-auto mt-6 mb-8 class="astro-GVPN4U4B">
    <h1 text-4xl font-bold leading-12 my-0 class="astro-GVPN4U4B">Implement Monocular Visual Odometry</h1>
    <p opacity-50 mt-2 class="astro-GVPN4U4B">
      Dec 19, 2022 · 11 min
      <span class="astro-GVPN4U4B">
            ·
            <span i-uil:tag-alt text-sm class="astro-GVPN4U4B"></span>
            <span class="astro-GVPN4U4B">
                <a href="/posts/tags/computer-vision" class="hover:underline astro-GVPN4U4B">
                  computer vision
                </a>
                
              </span>
          </span>
    </p>
  </div><div class="post prose prose-lg mx-auto mb-16 astro-GVPN4U4B">
    <ul class="table-of-contents">
<li>
<p><a href="#problem">Problem</a></p>
</li>
<li>
<p><a href="#feature-detection">Feature Detection</a></p>
</li>
<li>
<p><a href="#feature-tracking">Feature Tracking</a></p>
</li>
<li>
<p><a href="#fundamental-matrix">Fundamental Matrix</a></p>
<ul>
<li><a href="#_8-point-algorithm">8-Point Algorithm</a></li>
<li><a href="#ransac">RANSAC</a></li>
</ul>
</li>
<li>
<p><a href="#essential-matrix">Essential Matrix</a></p>
</li>
<li>
<p><a href="#camera-pose">Camera Pose</a></p>
</li>
<li>
<p><a href="#trajectory">Trajectory</a></p>
</li>
<li>
<p><a href="#references">References</a></p>
</li>
</ul>
<p>Monocular Visual Odometry (VO) is the process of estimating the pose (position and orientation) of a camera using only visual information from a single camera. It is a crucial component of many robotics and augmented reality systems, as it allows a device to understand its own movement and position in the world.</p>
<p>This blog would be focussing on how to implement a simple monocular VO algorithm in Python. If you are new to it, I suggest having a look at <a href="https://cmsc426.github.io/sfm/" target="_blank" rel="noopener noreferrer">this article</a>.</p>
<p>The overall process can be broken down into the following steps:</p>
<ul>
<li>Feature detection</li>
<li>Feature tracking</li>
<li>Estimating fundamental matrix</li>
<li>Estimating essential matrix (from fundamental matrix)</li>
<li>Recovering pose (from essential matrix)</li>
</ul>
<h2 id="problem"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#problem">#</a>Problem</h2>
<p>Suppose that we have a camera attached to a vehicle. A video coming from this camera has been processed for lens distortion and converted to frames. We denote the frames captured at time <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> as <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">I_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span>, respectively. For every pair of images <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>I</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(I_i, I_{i+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>, our job is to find the rotation matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and the translation vector <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">t_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, which describe the motion of the vehicle between the two frames.</p>
<h2 id="feature-detection"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#feature-detection">#</a>Feature Detection</h2>
<p>We first look for salient landmarks, called keypoints <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, in <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">I_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>. Keypoints are features that differ from their immediate neighborhood such as corners or areas with unique colors or textures. These features should ideally be found in both two adjacent frames.</p>
<p>Using OpenCV, detecting keypoints is trivial:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #CF222E">import</span><span style="color: #24292F"> cv2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">detect_features</span><span style="color: #24292F">(image):</span></span>
<span class="line"><span style="color: #24292F">    detector </span><span style="color: #CF222E">=</span><span style="color: #24292F"> cv2.GFTTDetector_create()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    kp </span><span style="color: #CF222E">=</span><span style="color: #24292F"> detector.detect(image)</span></span>
<span class="line"><span style="color: #24292F">    kp </span><span style="color: #CF222E">=</span><span style="color: #24292F"> cv2.KeyPoint_convert(</span><span style="color: #0550AE">sorted</span><span style="color: #24292F">(kp, </span><span style="color: #953800">key</span><span style="color: #CF222E">=lambda</span><span style="color: #24292F"> p: p.response, </span><span style="color: #953800">reverse</span><span style="color: #CF222E">=</span><span style="color: #0550AE">True</span><span style="color: #24292F">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> kp</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">kp1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> detect_features(image1)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> cv2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">detect_features</span><span style="color: #C9D1D9">(image):</span></span>
<span class="line"><span style="color: #C9D1D9">    detector </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> cv2.GFTTDetector_create()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    kp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> detector.detect(image)</span></span>
<span class="line"><span style="color: #C9D1D9">    kp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> cv2.KeyPoint_convert(</span><span style="color: #79C0FF">sorted</span><span style="color: #C9D1D9">(kp, </span><span style="color: #FFA657">key</span><span style="color: #FF7B72">=lambda</span><span style="color: #C9D1D9"> p: p.response, </span><span style="color: #FFA657">reverse</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> kp</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">kp1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> detect_features(image1)</span></span></code></pre></div>
</div>
<p>Here GFTT (Good Features to Track) detector is used to detect keypoints. In my experiments, other detectors like SIFT (Scale Invariant Feature Transform) and ORB (Oriented Fast and Rotated Brief) perform worse than GFTT. Meanwhile, the speed of SIFT is much slower.</p>
<h2 id="feature-tracking"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#feature-tracking">#</a>Feature Tracking</h2>
<p>We then need to track <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>’s corresponding keypoints <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">K_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span> in <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span> using optical flow. To improve the performance, you can choose to remove the keypoints that are not tracked in <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span> (<code>status</code> returned by <code>cv2.calcOpticalFlowPyrLK</code> is 0) or are outside <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span>.</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">get_removed_pts_ids</span><span style="color: #24292F">(pts, image, status):</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #0A3069">"""Removes keypoints that are not tracked or are outside the image."""</span></span>
<span class="line"><span style="color: #24292F">    status_ </span><span style="color: #CF222E">=</span><span style="color: #24292F"> status.copy()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">for</span><span style="color: #24292F"> idx, pt </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #0550AE">enumerate</span><span style="color: #24292F">(pts):</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">if</span><span style="color: #24292F"> pt[</span><span style="color: #0550AE">0</span><span style="color: #24292F">] </span><span style="color: #CF222E">&#x3C;</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F"> </span><span style="color: #CF222E">or</span><span style="color: #24292F"> pt[</span><span style="color: #0550AE">1</span><span style="color: #24292F">] </span><span style="color: #CF222E">&#x3C;</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F"> </span><span style="color: #CF222E">or</span><span style="color: #24292F"> pt[</span><span style="color: #0550AE">0</span><span style="color: #24292F">] </span><span style="color: #CF222E">></span><span style="color: #24292F"> image.shape[</span><span style="color: #0550AE">1</span><span style="color: #24292F">] </span><span style="color: #CF222E">or</span><span style="color: #24292F"> pt[</span><span style="color: #0550AE">1</span><span style="color: #24292F">] </span><span style="color: #CF222E">></span><span style="color: #24292F"> image.shape[</span><span style="color: #0550AE">0</span><span style="color: #24292F">]:</span></span>
<span class="line"><span style="color: #24292F">            status_[idx] </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> np.where(status_ </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">)[</span><span style="color: #0550AE">0</span><span style="color: #24292F">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">track_features</span><span style="color: #24292F">(image1, image2, kp1, remove_outliers: </span><span style="color: #0550AE">bool</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">False</span><span style="color: #24292F">):</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #0A3069">"""Tracks features using optical flow."""</span></span>
<span class="line"><span style="color: #24292F">    kp2, status, _ </span><span style="color: #CF222E">=</span><span style="color: #24292F"> cv2.calcOpticalFlowPyrLK(image1, image2, kp1, </span><span style="color: #0550AE">None</span><span style="color: #24292F">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">if</span><span style="color: #24292F"> remove_outliers:</span></span>
<span class="line"><span style="color: #24292F">        removed_ids </span><span style="color: #CF222E">=</span><span style="color: #24292F"> get_removed_pts_ids(kp2, image2, status)</span></span>
<span class="line"><span style="color: #24292F">        kp1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.delete(kp1, removed_ids, </span><span style="color: #953800">axis</span><span style="color: #CF222E">=</span><span style="color: #0550AE">0</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">        kp2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.delete(kp2, removed_ids, </span><span style="color: #953800">axis</span><span style="color: #CF222E">=</span><span style="color: #0550AE">0</span><span style="color: #24292F">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> kp1, kp2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">kp1, kp2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> track_features(image1, image2, kp1, </span><span style="color: #953800">remove_outliers</span><span style="color: #CF222E">=</span><span style="color: #0550AE">True</span><span style="color: #24292F">)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">get_removed_pts_ids</span><span style="color: #C9D1D9">(pts, image, status):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"""Removes keypoints that are not tracked or are outside the image."""</span></span>
<span class="line"><span style="color: #C9D1D9">    status_ </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> status.copy()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> idx, pt </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">enumerate</span><span style="color: #C9D1D9">(pts):</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> pt[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">or</span><span style="color: #C9D1D9"> pt[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">or</span><span style="color: #C9D1D9"> pt[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> image.shape[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">or</span><span style="color: #C9D1D9"> pt[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> image.shape[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]:</span></span>
<span class="line"><span style="color: #C9D1D9">            status_[idx] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> np.where(status_ </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">track_features</span><span style="color: #C9D1D9">(image1, image2, kp1, remove_outliers: </span><span style="color: #79C0FF">bool</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"""Tracks features using optical flow."""</span></span>
<span class="line"><span style="color: #C9D1D9">    kp2, status, _ </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> cv2.calcOpticalFlowPyrLK(image1, image2, kp1, </span><span style="color: #79C0FF">None</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> remove_outliers:</span></span>
<span class="line"><span style="color: #C9D1D9">        removed_ids </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> get_removed_pts_ids(kp2, image2, status)</span></span>
<span class="line"><span style="color: #C9D1D9">        kp1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.delete(kp1, removed_ids, </span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        kp2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.delete(kp2, removed_ids, </span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> kp1, kp2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">kp1, kp2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> track_features(image1, image2, kp1, </span><span style="color: #FFA657">remove_outliers</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span></code></pre></div>
</div>
<h2 id="fundamental-matrix"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#fundamental-matrix">#</a>Fundamental Matrix</h2>
<p>The fundamental matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>12</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>13</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>22</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>23</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>31</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>32</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>33</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">F = \begin{bmatrix}
    f_{11} &#x26; f_{12} &#x26; f_{13} \\
    f_{21} &#x26; f_{22} &#x26; f_{23} \\
    f_{31} &#x26; f_{32} &#x26; f_{33}
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-2.25em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-3.397em;"><span class="pstrut" style="height:3.155em;"></span><span style="height:0.016em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.6667em" height="0.016em" style="width:0.6667em" viewBox="0 0 666.67 16" preserveAspectRatio="xMinYMin"><path d="M319 0 H403 V16 H319z M319 0 H403 V16 H319z"></path></svg></span></span><span style="top:-4.05em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">13</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">23</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">33</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-2.25em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-3.397em;"><span class="pstrut" style="height:3.155em;"></span><span style="height:0.016em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.6667em" height="0.016em" style="width:0.6667em" viewBox="0 0 666.67 16" preserveAspectRatio="xMinYMin"><path d="M263 0 H347 V16 H263z M263 0 H347 V16 H263z"></path></svg></span></span><span style="top:-4.05em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span></span></span></span></span> is a <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span></span> matrix that encodes the relative orientation and position of the camera between <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">I_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">I_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span>.</p>
<h3 id="_8-point-algorithm"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#_8-point-algorithm">#</a>8-Point Algorithm</h3>
<p>To estimate <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span>, one of the solutions is <a href="https://www.cs.cmu.edu/~16385/s17/Slides/12.4_8Point_Algorithm.pdf" target="_blank" rel="noopener noreferrer">Hartley’s normalized 8-point algorithm</a>, where the constraint for <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> is:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center center center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup><msubsup><mi>x</mi><mi>i</mi><mn>1</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup><msubsup><mi>y</mi><mi>i</mi><mn>1</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup><msubsup><mi>x</mi><mi>i</mi><mn>1</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup><msubsup><mi>y</mi><mi>i</mi><mn>1</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>i</mi><mn>1</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>y</mi><mi>i</mi><mn>1</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup><msubsup><mi>x</mi><mi>i</mi><mn>8</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup><msubsup><mi>y</mi><mi>i</mi><mn>8</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup><msubsup><mi>x</mi><mi>i</mi><mn>8</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup><msubsup><mi>y</mi><mi>i</mi><mn>8</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>8</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>i</mi><mn>8</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>y</mi><mi>i</mi><mn>8</mn></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>11</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>12</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>13</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>21</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>22</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>23</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>31</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>32</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>f</mi><mn>33</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mn>0</mn><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
    x_{i+1}^1 x_i^1 &#x26; x_{i+1}^1 y_i^1 &#x26; x_{i+1}^1 &#x26; y_{i+1}^1 x_i^1 &#x26; y_{i+1}^1 y_i^1 &#x26; y_{i+1}^1 &#x26; x_i^1 &#x26; y_i^1 &#x26; 1 \\
    \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26; \vdots &#x26;  \vdots \\
    x_{i+1}^8 x_i^8 &#x26; x_{i+1}^8 y_i^8 &#x26; x_{i+1}^8 &#x26; y_{i+1}^8 x_i^8 &#x26; y_{i+1}^8 y_i^8 &#x26; y_{i+1}^8 &#x26; x_i^8 &#x26; y_i^8 &#x26; 1
\end{bmatrix}
\begin{bmatrix}
    f_{11} \\
    f_{12} \\
    f_{13} \\
    f_{21} \\
    f_{22} \\
    f_{23} \\
    f_{31} \\
    f_{32} \\
    f_{33}
\end{bmatrix}
= 0,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:10.8002em;vertical-align:-5.1501em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-1.95em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-3.097em;"><span class="pstrut" style="height:3.155em;"></span><span style="height:0.616em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.6667em" height="0.616em" style="width:0.6667em" viewBox="0 0 666.67 616" preserveAspectRatio="xMinYMin"><path d="M319 0 H403 V616 H319z M319 0 H403 V616 H319z"></path></svg></span></span><span style="top:-4.35em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.317em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.38em;"><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.3675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.88em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-1.95em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-3.097em;"><span class="pstrut" style="height:3.155em;"></span><span style="height:0.616em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.6667em" height="0.616em" style="width:0.6667em" viewBox="0 0 666.67 616" preserveAspectRatio="xMinYMin"><path d="M263 0 H347 V616 H263z M263 0 H347 V616 H263z"></path></svg></span></span><span style="top:-4.35em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.6501em;"><span style="top:-4.7111em;"><span class="pstrut" style="height:9.2161em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-5.8581em;"><span class="pstrut" style="height:9.2161em;"></span><span style="height:7.2161em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.6667em" height="7.2161em" style="width:0.6667em" viewBox="0 0 666.67 7216" preserveAspectRatio="xMinYMin"><path d="M319 0 H403 V7216 H319z M319 0 H403 V7216 H319z"></path></svg></span></span><span style="top:-13.7112em;"><span class="pstrut" style="height:9.2161em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.1501em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.65em;"><span style="top:-7.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-6.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">13</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">23</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-0.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:0.59em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:1.79em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">33</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.15em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.6501em;"><span style="top:-4.7111em;"><span class="pstrut" style="height:9.2161em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-5.8581em;"><span class="pstrut" style="height:9.2161em;"></span><span style="height:7.2161em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.6667em" height="7.2161em" style="width:0.6667em" viewBox="0 0 666.67 7216" preserveAspectRatio="xMinYMin"><path d="M263 0 H347 V7216 H263z M263 0 H347 V7216 H263z"></path></svg></span></span><span style="top:-13.7112em;"><span class="pstrut" style="height:9.2161em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.1501em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">0</span><span class="mpunct">,</span></span></span></span></span></div>
<p>which can be answered by solving the linear least squares using Singular Value Decomposition (SVD). This algorithm requires 8 keypoint correspondences exists, where <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_i, y_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> are the coordinates of the 8 keypoints selected from <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>, and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_{i+1}, y_{i+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> are the coordinates of their corresponding keypoints in <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">K_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span>. The coordinates should be normalized by shifting them around the mean of the points and enclosing them at a distance of <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mn>2</mn></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1328em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span></span></span></span></span></span></span></span></span></span> from the new center.</p>
<p>Given 8 keypoint correspondences, the code for computing <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> is:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #CF222E">import</span><span style="color: #24292F"> numpy </span><span style="color: #CF222E">as</span><span style="color: #24292F"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">normalize</span><span style="color: #24292F">(pt: np.ndarray):</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #0A3069">"""Normalizes the given set of points."""</span></span>
<span class="line"><span style="color: #24292F">    N </span><span style="color: #CF222E">=</span><span style="color: #24292F"> pt.shape[</span><span style="color: #0550AE">0</span><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #24292F">    mean </span><span style="color: #CF222E">=</span><span style="color: #24292F"> pt </span><span style="color: #CF222E">-</span><span style="color: #24292F"> np.mean(pt, </span><span style="color: #953800">axis</span><span style="color: #CF222E">=</span><span style="color: #0550AE">0</span><span style="color: #24292F">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    scale </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.sum(np.square(pt)) </span><span style="color: #CF222E">/</span><span style="color: #24292F"> (</span><span style="color: #0550AE">2</span><span style="color: #24292F"> </span><span style="color: #CF222E">*</span><span style="color: #24292F"> N)</span></span>
<span class="line"><span style="color: #24292F">    scale </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.sqrt(</span><span style="color: #0550AE">1</span><span style="color: #24292F"> </span><span style="color: #CF222E">/</span><span style="color: #24292F"> scale)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> scale </span><span style="color: #CF222E">*</span><span style="color: #24292F"> mean, scale</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">compute_fundamental_mat</span><span style="color: #24292F">(pt1: np.ndarray, pt2: np.ndarray)-> np.ndarray:</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #0A3069">"""Computes the fundamental matrix F using SVD."""</span></span>
<span class="line"><span style="color: #24292F">    N </span><span style="color: #CF222E">=</span><span style="color: #24292F"> pt1.shape[</span><span style="color: #0550AE">0</span><span style="color: #24292F">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    norm_pt1, scale1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> normalize(pt1)</span></span>
<span class="line"><span style="color: #24292F">    norm_pt2, scale2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> normalize(pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    T1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.array([</span></span>
<span class="line"><span style="color: #24292F">        [scale1, </span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #CF222E">-</span><span style="color: #24292F"> scale1 </span><span style="color: #CF222E">*</span><span style="color: #24292F"> np.mean(pt1[:, </span><span style="color: #0550AE">0</span><span style="color: #24292F">])],</span></span>
<span class="line"><span style="color: #24292F">        [</span><span style="color: #0550AE">0</span><span style="color: #24292F">, scale1, </span><span style="color: #CF222E">-</span><span style="color: #24292F"> scale1 </span><span style="color: #CF222E">*</span><span style="color: #24292F"> np.mean(pt1[:, </span><span style="color: #0550AE">1</span><span style="color: #24292F">])],</span></span>
<span class="line"><span style="color: #24292F">        [</span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #24292F">    ])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    T2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.array([</span></span>
<span class="line"><span style="color: #24292F">        [scale2, </span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #CF222E">-</span><span style="color: #24292F"> scale2 </span><span style="color: #CF222E">*</span><span style="color: #24292F"> np.mean(pt2[:, </span><span style="color: #0550AE">0</span><span style="color: #24292F">])],</span></span>
<span class="line"><span style="color: #24292F">        [</span><span style="color: #0550AE">0</span><span style="color: #24292F">, scale2, </span><span style="color: #CF222E">-</span><span style="color: #24292F"> scale2 </span><span style="color: #CF222E">*</span><span style="color: #24292F"> np.mean(pt2[:, </span><span style="color: #0550AE">1</span><span style="color: #24292F">])],</span></span>
<span class="line"><span style="color: #24292F">        [</span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #24292F">    ])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    A </span><span style="color: #CF222E">=</span><span style="color: #24292F"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">for</span><span style="color: #24292F"> i </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #0550AE">range</span><span style="color: #24292F">(N):</span></span>
<span class="line"><span style="color: #24292F">        x1, y1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> norm_pt1[i]</span></span>
<span class="line"><span style="color: #24292F">        x2, y2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> norm_pt2[i]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        a </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.array([x2 </span><span style="color: #CF222E">*</span><span style="color: #24292F"> x1, x2 </span><span style="color: #CF222E">*</span><span style="color: #24292F"> y1, x2, y2 </span><span style="color: #CF222E">*</span><span style="color: #24292F"> x1, y2 </span><span style="color: #CF222E">*</span><span style="color: #24292F"> y1, y2, x1, y1, </span><span style="color: #0550AE">1</span><span style="color: #24292F">])</span></span>
<span class="line"><span style="color: #24292F">        A.append(a)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    A </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.array(A)  </span><span style="color: #6E7781"># (N, 9)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    U1, S1, V1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.linalg.svd(A)</span></span>
<span class="line"><span style="color: #24292F">    F </span><span style="color: #CF222E">=</span><span style="color: #24292F"> V1[</span><span style="color: #CF222E">-</span><span style="color: #0550AE">1</span><span style="color: #24292F">,:].reshape(</span><span style="color: #0550AE">3</span><span style="color: #24292F">, </span><span style="color: #0550AE">3</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">    F </span><span style="color: #CF222E">/=</span><span style="color: #24292F"> F[</span><span style="color: #0550AE">2</span><span style="color: #24292F">, </span><span style="color: #0550AE">2</span><span style="color: #24292F">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    U2, S2, V2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.linalg.svd(F)</span></span>
<span class="line"><span style="color: #24292F">    S2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.diag(S2)</span></span>
<span class="line"><span style="color: #24292F">    S2[</span><span style="color: #CF222E">-</span><span style="color: #0550AE">1</span><span style="color: #24292F">] </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    F </span><span style="color: #CF222E">=</span><span style="color: #24292F"> U2 </span><span style="color: #CF222E">@</span><span style="color: #24292F"> S2 </span><span style="color: #CF222E">@</span><span style="color: #24292F"> V2</span></span>
<span class="line"><span style="color: #24292F">    F </span><span style="color: #CF222E">=</span><span style="color: #24292F"> T2.T </span><span style="color: #CF222E">@</span><span style="color: #24292F"> F </span><span style="color: #CF222E">@</span><span style="color: #24292F"> T1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> F</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> numpy </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">normalize</span><span style="color: #C9D1D9">(pt: np.ndarray):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"""Normalizes the given set of points."""</span></span>
<span class="line"><span style="color: #C9D1D9">    N </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pt.shape[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    mean </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pt </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> np.mean(pt, </span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    scale </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.sum(np.square(pt)) </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> N)</span></span>
<span class="line"><span style="color: #C9D1D9">    scale </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.sqrt(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> scale)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> scale </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> mean, scale</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">compute_fundamental_mat</span><span style="color: #C9D1D9">(pt1: np.ndarray, pt2: np.ndarray)-> np.ndarray:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"""Computes the fundamental matrix F using SVD."""</span></span>
<span class="line"><span style="color: #C9D1D9">    N </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pt1.shape[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    norm_pt1, scale1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> normalize(pt1)</span></span>
<span class="line"><span style="color: #C9D1D9">    norm_pt2, scale2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> normalize(pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    T1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.array([</span></span>
<span class="line"><span style="color: #C9D1D9">        [scale1, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> scale1 </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> np.mean(pt1[:, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">])],</span></span>
<span class="line"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, scale1, </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> scale1 </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> np.mean(pt1[:, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">])],</span></span>
<span class="line"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    ])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    T2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.array([</span></span>
<span class="line"><span style="color: #C9D1D9">        [scale2, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> scale2 </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> np.mean(pt2[:, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">])],</span></span>
<span class="line"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, scale2, </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> scale2 </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> np.mean(pt2[:, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">])],</span></span>
<span class="line"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    ])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    A </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(N):</span></span>
<span class="line"><span style="color: #C9D1D9">        x1, y1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> norm_pt1[i]</span></span>
<span class="line"><span style="color: #C9D1D9">        x2, y2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> norm_pt2[i]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        a </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.array([x2 </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> x1, x2 </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> y1, x2, y2 </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> x1, y2 </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> y1, y2, x1, y1, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">        A.append(a)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    A </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.array(A)  </span><span style="color: #8B949E"># (N, 9)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    U1, S1, V1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.linalg.svd(A)</span></span>
<span class="line"><span style="color: #C9D1D9">    F </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> V1[</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">,:].reshape(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    F </span><span style="color: #FF7B72">/=</span><span style="color: #C9D1D9"> F[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    U2, S2, V2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.linalg.svd(F)</span></span>
<span class="line"><span style="color: #C9D1D9">    S2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.diag(S2)</span></span>
<span class="line"><span style="color: #C9D1D9">    S2[</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    F </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> U2 </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> S2 </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> V2</span></span>
<span class="line"><span style="color: #C9D1D9">    F </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> T2.T </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> F </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> T1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> F</span></span></code></pre></div>
</div>
<h3 id="ransac"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#ransac">#</a>RANSAC</h3>
<p>Our feature detection and tracking algorithms are not perfect, leading to several erroneous correspondences (outliers). Therefore, RANSAC is used to remove these outliers.</p>
<p>RANSAC is an iterative algorithm terminating after a fixed number of iterations. At every iteration, it works in the following way:</p>
<ul>
<li>Picks 8 keypoint correspondences from <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">K_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span></li>
<li>Computes <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> using Hartley’s 8-point algorithm mentioned above</li>
<li>Determines how many of all other keypoints are inliers</li>
</ul>
<p>Finally, the <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> with the maximum number of inliers will be used.</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">compute_ransac_error</span><span style="color: #24292F">(F: np.ndarray, pt1: np.ndarray, pt2: np.ndarray):</span></span>
<span class="line"><span style="color: #24292F">    n </span><span style="color: #CF222E">=</span><span style="color: #24292F"> pt1.shape[</span><span style="color: #0550AE">0</span><span style="color: #24292F">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    p1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.hstack((pt1, np.ones((n, </span><span style="color: #0550AE">1</span><span style="color: #24292F">))))</span></span>
<span class="line"><span style="color: #24292F">    p2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.hstack((pt2, np.ones((n, </span><span style="color: #0550AE">1</span><span style="color: #24292F">))))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    e1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> p1 </span><span style="color: #CF222E">@</span><span style="color: #24292F"> F.T</span></span>
<span class="line"><span style="color: #24292F">    e2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> p2 </span><span style="color: #CF222E">@</span><span style="color: #24292F"> F</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    error </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.sum(e2 </span><span style="color: #CF222E">*</span><span style="color: #24292F"> p1, </span><span style="color: #953800">axis</span><span style="color: #CF222E">=</span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #953800">keepdims</span><span style="color: #CF222E">=</span><span style="color: #0550AE">True</span><span style="color: #24292F">) </span><span style="color: #CF222E">**</span><span style="color: #24292F"> </span><span style="color: #0550AE">2</span><span style="color: #24292F"> </span><span style="color: #CF222E">/</span><span style="color: #24292F"> np.sum(np.hstack((e1[:, :</span><span style="color: #CF222E">-</span><span style="color: #0550AE">1</span><span style="color: #24292F">], e2[:, :</span><span style="color: #CF222E">-</span><span style="color: #0550AE">1</span><span style="color: #24292F">])) </span><span style="color: #CF222E">**</span><span style="color: #24292F"> </span><span style="color: #0550AE">2</span><span style="color: #24292F">, </span><span style="color: #953800">axis</span><span style="color: #CF222E">=</span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #953800">keepdims</span><span style="color: #CF222E">=</span><span style="color: #0550AE">True</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> error</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">find_fundamental_mat</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">    pt1: np.ndarray, pt2: np.ndarray, threshold: </span><span style="color: #0550AE">float</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0.05</span></span>
<span class="line"><span style="color: #24292F">)-> np.ndarray:</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #0A3069">"""Estimates the fundamental matrix using RANSAC."""</span></span>
<span class="line"><span style="color: #24292F">    max_inliers </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span></span>
<span class="line"><span style="color: #24292F">    best_F </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">None</span></span>
<span class="line"><span style="color: #24292F">    confidence </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0.99</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    N </span><span style="color: #CF222E">=</span><span style="color: #24292F"> sys.maxsize</span></span>
<span class="line"><span style="color: #24292F">    count </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">while</span><span style="color: #24292F"> N </span><span style="color: #CF222E">></span><span style="color: #24292F"> count:</span></span>
<span class="line"><span style="color: #24292F">        x, y </span><span style="color: #CF222E">=</span><span style="color: #24292F"> sample_eight_points(pt1, pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        F </span><span style="color: #CF222E">=</span><span style="color: #24292F"> compute_fundamental_mat(x, y)</span></span>
<span class="line"><span style="color: #24292F">        error </span><span style="color: #CF222E">=</span><span style="color: #24292F"> compute_ransac_error(F, pt1, pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        inliers </span><span style="color: #CF222E">=</span><span style="color: #24292F"> error </span><span style="color: #CF222E">&#x3C;=</span><span style="color: #24292F"> threshold</span></span>
<span class="line"><span style="color: #24292F">        n_inliers </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.sum(inliers)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">if</span><span style="color: #24292F"> max_inliers </span><span style="color: #CF222E">&#x3C;</span><span style="color: #24292F"> np.sum(inliers):</span></span>
<span class="line"><span style="color: #24292F">            max_inliers </span><span style="color: #CF222E">=</span><span style="color: #24292F"> n_inliers</span></span>
<span class="line"><span style="color: #24292F">            best_F </span><span style="color: #CF222E">=</span><span style="color: #24292F"> F.copy()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        ratio </span><span style="color: #CF222E">=</span><span style="color: #24292F"> n_inliers </span><span style="color: #CF222E">/</span><span style="color: #24292F"> </span><span style="color: #0550AE">len</span><span style="color: #24292F">(pt1)</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">if</span><span style="color: #24292F"> np.log(</span><span style="color: #0550AE">1</span><span style="color: #24292F"> </span><span style="color: #CF222E">-</span><span style="color: #24292F"> (ratio </span><span style="color: #CF222E">**</span><span style="color: #24292F"> </span><span style="color: #0550AE">8</span><span style="color: #24292F">)) </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">continue</span></span>
<span class="line"><span style="color: #24292F">        N </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.log(</span><span style="color: #0550AE">1</span><span style="color: #24292F"> </span><span style="color: #CF222E">-</span><span style="color: #24292F"> confidence) </span><span style="color: #CF222E">/</span><span style="color: #24292F"> np.log(</span><span style="color: #0550AE">1</span><span style="color: #24292F"> </span><span style="color: #CF222E">-</span><span style="color: #24292F"> (ratio </span><span style="color: #CF222E">**</span><span style="color: #24292F"> </span><span style="color: #0550AE">8</span><span style="color: #24292F">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        count </span><span style="color: #CF222E">+=</span><span style="color: #24292F"> </span><span style="color: #0550AE">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> best_F</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">F </span><span style="color: #CF222E">=</span><span style="color: #24292F"> find_fundamental_mat(kp1, kp2, </span><span style="color: #0550AE">0.05</span><span style="color: #24292F">)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">compute_ransac_error</span><span style="color: #C9D1D9">(F: np.ndarray, pt1: np.ndarray, pt2: np.ndarray):</span></span>
<span class="line"><span style="color: #C9D1D9">    n </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pt1.shape[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    p1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.hstack((pt1, np.ones((n, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">))))</span></span>
<span class="line"><span style="color: #C9D1D9">    p2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.hstack((pt2, np.ones((n, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">))))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    e1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> p1 </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> F.T</span></span>
<span class="line"><span style="color: #C9D1D9">    e2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> p2 </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> F</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    error </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.sum(e2 </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> p1, </span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">keepdims</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">**</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> np.sum(np.hstack((e1[:, :</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], e2[:, :</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">])) </span><span style="color: #FF7B72">**</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">keepdims</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> error</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">find_fundamental_mat</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">    pt1: np.ndarray, pt2: np.ndarray, threshold: </span><span style="color: #79C0FF">float</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0.05</span></span>
<span class="line"><span style="color: #C9D1D9">)-> np.ndarray:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"""Estimates the fundamental matrix using RANSAC."""</span></span>
<span class="line"><span style="color: #C9D1D9">    max_inliers </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">    best_F </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">None</span></span>
<span class="line"><span style="color: #C9D1D9">    confidence </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0.99</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    N </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> sys.maxsize</span></span>
<span class="line"><span style="color: #C9D1D9">    count </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> N </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> count:</span></span>
<span class="line"><span style="color: #C9D1D9">        x, y </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> sample_eight_points(pt1, pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        F </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> compute_fundamental_mat(x, y)</span></span>
<span class="line"><span style="color: #C9D1D9">        error </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> compute_ransac_error(F, pt1, pt2)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        inliers </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> error </span><span style="color: #FF7B72">&#x3C;=</span><span style="color: #C9D1D9"> threshold</span></span>
<span class="line"><span style="color: #C9D1D9">        n_inliers </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.sum(inliers)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> max_inliers </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> np.sum(inliers):</span></span>
<span class="line"><span style="color: #C9D1D9">            max_inliers </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> n_inliers</span></span>
<span class="line"><span style="color: #C9D1D9">            best_F </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> F.copy()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        ratio </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> n_inliers </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(pt1)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> np.log(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> (ratio </span><span style="color: #FF7B72">**</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">)) </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">continue</span></span>
<span class="line"><span style="color: #C9D1D9">        N </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.log(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> confidence) </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> np.log(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> (ratio </span><span style="color: #FF7B72">**</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        count </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> best_F</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">F </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> find_fundamental_mat(kp1, kp2, </span><span style="color: #79C0FF">0.05</span><span style="color: #C9D1D9">)</span></span></code></pre></div>
</div>
<p>Then the problem is how to pick 8 keypoint correspondences (<code>sample_eight_points</code>). While Hartley’s 8-point algorithm samples them randomly, to make the algorithm more robust to outliers, we can use the way mentioned <a href="https://www.crcv.ucf.edu/wp-content/uploads/2019/03/Lecture-13-FundamentalMatrix.pdf" target="_blank" rel="noopener noreferrer">here</a> (page 39) instead: uniformly dividing a frame into an <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8 \times 8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">8</span></span></span></span></span> grid, then randomly selecting 8 grid cells and picking one pair of corresponding keypoints from each grid cell.</p>
<h2 id="essential-matrix"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#essential-matrix">#</a>Essential Matrix</h2>
<p>Essential matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> is another <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span></span> matrix. But unlike <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> assumes that the cameras obey the pinhole model. More specifically, given the camera calibration matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo>=</mo><msup><mi>K</mi><mi>T</mi></msup><mi>F</mi><mi>K</mi></mrow><annotation encoding="application/x-tex">E = K^T F K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>, which also can be solved using SVD.</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">find_essential_mat</span><span style="color: #24292F">(K: np.ndarray, F: np.ndarray)-> np.ndarray:</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #0A3069">"""Estimates the essential matrix."""</span></span>
<span class="line"><span style="color: #24292F">    E </span><span style="color: #CF222E">=</span><span style="color: #24292F"> K.T </span><span style="color: #CF222E">@</span><span style="color: #24292F"> F </span><span style="color: #CF222E">@</span><span style="color: #24292F"> K</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    U, S, V </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.linalg.svd(E)</span></span>
<span class="line highlighted"><span style="color: #24292F">    S </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.asarray([</span></span>
<span class="line highlighted"><span style="color: #24292F">        [</span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">0</span><span style="color: #24292F">],</span></span>
<span class="line highlighted"><span style="color: #24292F">        [</span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #0550AE">0</span><span style="color: #24292F">],</span></span>
<span class="line highlighted"><span style="color: #24292F">        [</span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">0</span><span style="color: #24292F">]</span></span>
<span class="line highlighted"><span style="color: #24292F">    ])</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color: #24292F">    E </span><span style="color: #CF222E">=</span><span style="color: #24292F"> U </span><span style="color: #CF222E">@</span><span style="color: #24292F"> S </span><span style="color: #CF222E">@</span><span style="color: #24292F"> V</span></span>
<span class="line"><span style="color: #24292F">    E </span><span style="color: #CF222E">=</span><span style="color: #24292F"> E </span><span style="color: #CF222E">/</span><span style="color: #24292F"> np.linalg.norm(E)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> E</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">E </span><span style="color: #CF222E">=</span><span style="color: #24292F"> find_essential_mat(K, F)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">find_essential_mat</span><span style="color: #C9D1D9">(K: np.ndarray, F: np.ndarray)-> np.ndarray:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"""Estimates the essential matrix."""</span></span>
<span class="line"><span style="color: #C9D1D9">    E </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> K.T </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> F </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> K</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    U, S, V </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.linalg.svd(E)</span></span>
<span class="line highlighted"><span style="color: #C9D1D9">    S </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.asarray([</span></span>
<span class="line highlighted"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">],</span></span>
<span class="line highlighted"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">],</span></span>
<span class="line highlighted"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line highlighted"><span style="color: #C9D1D9">    ])</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color: #C9D1D9">    E </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> U </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> S </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> V</span></span>
<span class="line"><span style="color: #C9D1D9">    E </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> E </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> np.linalg.norm(E)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> E</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">E </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> find_essential_mat(K, F)</span></span></code></pre></div>
</div>
<p>Note that the singular values of <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> are not necessarily <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1, 1, 0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span> due to the noise in K. Thus <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> should be reconstructed with <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1, 1, 0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span> singular values:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo>=</mo><mi>U</mi><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><msup><mi>V</mi><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">E = U

\begin{bmatrix}
    1 &#x26; 0 &#x26; 0 \\
    0 &#x26; 1 &#x26; 0 \\
    0 &#x26; 0 &#x26; 0 \\
\end{bmatrix}

V^\top</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-2.25em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-3.397em;"><span class="pstrut" style="height:3.155em;"></span><span style="height:0.016em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.6667em" height="0.016em" style="width:0.6667em" viewBox="0 0 666.67 16" preserveAspectRatio="xMinYMin"><path d="M319 0 H403 V16 H319z M319 0 H403 V16 H319z"></path></svg></span></span><span style="top:-4.05em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-2.25em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-3.397em;"><span class="pstrut" style="height:3.155em;"></span><span style="height:0.016em;width:0.6667em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.6667em" height="0.016em" style="width:0.6667em" viewBox="0 0 666.67 16" preserveAspectRatio="xMinYMin"><path d="M263 0 H347 V16 H263z M263 0 H347 V16 H263z"></path></svg></span></span><span style="top:-4.05em;"><span class="pstrut" style="height:3.155em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span></span></span></span></div>
<hr>
<p>Now we have successfully estimated the essential matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> manually, looks cool! However, this can also be done with the help of OpenCV, and all you need is one line:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #24292F">E, mask </span><span style="color: #CF222E">=</span><span style="color: #24292F"> cv2.findEssentialMat(kp2, kp1, K, cv2.</span><span style="color: #0550AE">RANSAC</span><span style="color: #24292F">, </span><span style="color: #0550AE">0.999</span><span style="color: #24292F">, </span><span style="color: #0550AE">0.3</span><span style="color: #24292F">, </span><span style="color: #0550AE">None</span><span style="color: #24292F">)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #C9D1D9">E, mask </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> cv2.findEssentialMat(kp2, kp1, K, cv2.</span><span style="color: #79C0FF">RANSAC</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0.999</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0.3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">None</span><span style="color: #C9D1D9">)</span></span></code></pre></div>
</div>
<p>OpenCV uses <a href="https://www-users.cse.umn.edu/~hspark/CSci5980/nister.pdf" target="_blank" rel="noopener noreferrer">Nistér’s 5-point algorithm</a>, a more recent approach that is shown to give better results, to compute <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span>. It requires the minimum number of keypoints possible since <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> has only 5 degrees of freedom (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></span> has 7 degrees of freedom, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span> has only 5 as it takes camera parameters into account).</p>
<h2 id="camera-pose"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#camera-pose">#</a>Camera Pose</h2>
<p>Just follow <a href="https://cmsc426.github.io/sfm/#essential" target="_blank" rel="noopener noreferrer">here</a> to recover the camera rotation matrix <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> and translation vector <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">t_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> from <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></span>.</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">linear_triangulation</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">    T1: np.ndarray,</span></span>
<span class="line"><span style="color: #24292F">    R1: np.ndarray,</span></span>
<span class="line"><span style="color: #24292F">    T2: np.ndarray,</span></span>
<span class="line"><span style="color: #24292F">    R2: np.ndarray,</span></span>
<span class="line"><span style="color: #24292F">    pt1: np.ndarray,</span></span>
<span class="line"><span style="color: #24292F">    pt2: np.ndarray,</span></span>
<span class="line"><span style="color: #24292F">    K: np.ndarray,</span></span>
<span class="line"><span style="color: #24292F">)-> np.ndarray:</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #0A3069">"""Linear triangulation."""</span></span>
<span class="line"><span style="color: #24292F">    P1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> K </span><span style="color: #CF222E">@</span><span style="color: #24292F"> np.hstack((R1, </span><span style="color: #CF222E">-</span><span style="color: #24292F">R1 </span><span style="color: #CF222E">@</span><span style="color: #24292F"> T1))</span></span>
<span class="line"><span style="color: #24292F">    P2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> K </span><span style="color: #CF222E">@</span><span style="color: #24292F"> np.hstack((R2, </span><span style="color: #CF222E">-</span><span style="color: #24292F">R2 </span><span style="color: #CF222E">@</span><span style="color: #24292F"> T2))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    X </span><span style="color: #CF222E">=</span><span style="color: #24292F"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">for</span><span style="color: #24292F"> i </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #0550AE">range</span><span style="color: #24292F">(</span><span style="color: #0550AE">len</span><span style="color: #24292F">(pt1)):</span></span>
<span class="line"><span style="color: #24292F">        x1, x2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> pt1[i], pt2[i]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        A1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> x1[</span><span style="color: #0550AE">0</span><span style="color: #24292F">] </span><span style="color: #CF222E">*</span><span style="color: #24292F"> P1[</span><span style="color: #0550AE">2</span><span style="color: #24292F">, :] </span><span style="color: #CF222E">-</span><span style="color: #24292F"> P1[</span><span style="color: #0550AE">0</span><span style="color: #24292F">, :]</span></span>
<span class="line"><span style="color: #24292F">        A2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> x1[</span><span style="color: #0550AE">1</span><span style="color: #24292F">] </span><span style="color: #CF222E">*</span><span style="color: #24292F"> P1[</span><span style="color: #0550AE">2</span><span style="color: #24292F">, :] </span><span style="color: #CF222E">-</span><span style="color: #24292F"> P1[</span><span style="color: #0550AE">1</span><span style="color: #24292F">, :]</span></span>
<span class="line"><span style="color: #24292F">        A3 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> x2[</span><span style="color: #0550AE">0</span><span style="color: #24292F">] </span><span style="color: #CF222E">*</span><span style="color: #24292F"> P2[</span><span style="color: #0550AE">2</span><span style="color: #24292F">, :] </span><span style="color: #CF222E">-</span><span style="color: #24292F"> P2[</span><span style="color: #0550AE">0</span><span style="color: #24292F">, :]</span></span>
<span class="line"><span style="color: #24292F">        A4 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> x2[</span><span style="color: #0550AE">1</span><span style="color: #24292F">] </span><span style="color: #CF222E">*</span><span style="color: #24292F"> P2[</span><span style="color: #0550AE">2</span><span style="color: #24292F">, :] </span><span style="color: #CF222E">-</span><span style="color: #24292F"> P2[</span><span style="color: #0550AE">1</span><span style="color: #24292F">, :]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        A </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.asarray([A1, A2, A3, A4])</span></span>
<span class="line"><span style="color: #24292F">        U, S, V </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.linalg.svd(A)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        V </span><span style="color: #CF222E">=</span><span style="color: #24292F"> V[</span><span style="color: #0550AE">3</span><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #24292F">        V </span><span style="color: #CF222E">=</span><span style="color: #24292F"> V </span><span style="color: #CF222E">/</span><span style="color: #24292F"> V[</span><span style="color: #CF222E">-</span><span style="color: #0550AE">1</span><span style="color: #24292F">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        X.append(V)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> np.asarray(X)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">recover_pose</span><span style="color: #24292F">(E: np.ndarray, pt1, pt2, K: np.ndarray):</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #0A3069">"""Recovers the camera pose."""</span></span>
<span class="line"><span style="color: #24292F">    W </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.asarray([</span></span>
<span class="line"><span style="color: #24292F">        [</span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #CF222E">-</span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #0550AE">0</span><span style="color: #24292F">],</span></span>
<span class="line"><span style="color: #24292F">        [</span><span style="color: #0550AE">1</span><span style="color: #24292F">,  </span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">0</span><span style="color: #24292F">],</span></span>
<span class="line"><span style="color: #24292F">        [</span><span style="color: #0550AE">0</span><span style="color: #24292F">,  </span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #24292F">    ])</span></span>
<span class="line"><span style="color: #24292F">    U, S, V </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.linalg.svd(E)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    poses </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0A3069">"T1"</span><span style="color: #24292F">:  U[:, </span><span style="color: #0550AE">2</span><span style="color: #24292F">].reshape(</span><span style="color: #0550AE">3</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0A3069">"T2"</span><span style="color: #24292F">: </span><span style="color: #CF222E">-</span><span style="color: #24292F">U[:, </span><span style="color: #0550AE">2</span><span style="color: #24292F">].reshape(</span><span style="color: #0550AE">3</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0A3069">"T3"</span><span style="color: #24292F">:  U[:, </span><span style="color: #0550AE">2</span><span style="color: #24292F">].reshape(</span><span style="color: #0550AE">3</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0A3069">"T4"</span><span style="color: #24292F">: </span><span style="color: #CF222E">-</span><span style="color: #24292F">U[:, </span><span style="color: #0550AE">2</span><span style="color: #24292F">].reshape(</span><span style="color: #0550AE">3</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0A3069">"R1"</span><span style="color: #24292F">:  U </span><span style="color: #CF222E">@</span><span style="color: #24292F"> W   </span><span style="color: #CF222E">@</span><span style="color: #24292F"> V,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0A3069">"R2"</span><span style="color: #24292F">:  U </span><span style="color: #CF222E">@</span><span style="color: #24292F"> W   </span><span style="color: #CF222E">@</span><span style="color: #24292F"> V,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0A3069">"R3"</span><span style="color: #24292F">:  U </span><span style="color: #CF222E">@</span><span style="color: #24292F"> W.T </span><span style="color: #CF222E">@</span><span style="color: #24292F"> V,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0A3069">"R4"</span><span style="color: #24292F">:  U </span><span style="color: #CF222E">@</span><span style="color: #24292F"> W.T </span><span style="color: #CF222E">@</span><span style="color: #24292F"> V</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">for</span><span style="color: #24292F"> i </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #0550AE">range</span><span style="color: #24292F">(</span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #0550AE">5</span><span style="color: #24292F">):</span></span>
<span class="line"><span style="color: #24292F">        T, R </span><span style="color: #CF222E">=</span><span style="color: #24292F"> poses[</span><span style="color: #0A3069">"T"</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #0550AE">str</span><span style="color: #24292F">(i)], poses[</span><span style="color: #0A3069">"R"</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #0550AE">str</span><span style="color: #24292F">(i)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">if</span><span style="color: #24292F"> np.linalg.det(R) </span><span style="color: #CF222E">&#x3C;</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">            T </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">-</span><span style="color: #24292F">T</span></span>
<span class="line"><span style="color: #24292F">            R </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">-</span><span style="color: #24292F">R</span></span>
<span class="line"><span style="color: #24292F">            poses[</span><span style="color: #0A3069">"T"</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #0550AE">str</span><span style="color: #24292F">(i)], poses[</span><span style="color: #0A3069">"R"</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #0550AE">str</span><span style="color: #24292F">(i)] </span><span style="color: #CF222E">=</span><span style="color: #24292F"> T, R</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        I </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.identity(</span><span style="color: #0550AE">3</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">        M </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.hstack((I, T.reshape(</span><span style="color: #0550AE">3</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">)))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        poses[</span><span style="color: #0A3069">"P"</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #0550AE">str</span><span style="color: #24292F">(i)] </span><span style="color: #CF222E">=</span><span style="color: #24292F"> K </span><span style="color: #CF222E">@</span><span style="color: #24292F"> R </span><span style="color: #CF222E">@</span><span style="color: #24292F"> M</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    max_Z, rt_idx </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">for</span><span style="color: #24292F"> i </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #0550AE">range</span><span style="color: #24292F">(</span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #0550AE">5</span><span style="color: #24292F">):</span></span>
<span class="line"><span style="color: #24292F">        T1, R1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> poses[</span><span style="color: #0A3069">"T"</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #0550AE">str</span><span style="color: #24292F">(i)], poses[</span><span style="color: #0A3069">"R"</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #0550AE">str</span><span style="color: #24292F">(i)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #6E7781"># ---------------------</span></span>
<span class="line"><span style="color: #24292F">        T2, R2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.asarray([[</span><span style="color: #0550AE">0</span><span style="color: #24292F">],[</span><span style="color: #0550AE">0</span><span style="color: #24292F">],[</span><span style="color: #0550AE">0</span><span style="color: #24292F">]]), np.identity(</span><span style="color: #0550AE">3</span><span style="color: #24292F">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        X </span><span style="color: #CF222E">=</span><span style="color: #24292F"> linear_triangulation(T2, R2, T1, R1, pt1, pt2, K)</span></span>
<span class="line"><span style="color: #24292F">        Z </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">for</span><span style="color: #24292F"> j </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #0550AE">range</span><span style="color: #24292F">(X.shape[</span><span style="color: #0550AE">0</span><span style="color: #24292F">]):</span></span>
<span class="line"><span style="color: #24292F">            x </span><span style="color: #CF222E">=</span><span style="color: #24292F"> X[j, :].reshape(</span><span style="color: #CF222E">-</span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">if</span><span style="color: #24292F"> R1[</span><span style="color: #0550AE">2</span><span style="color: #24292F">] </span><span style="color: #CF222E">@</span><span style="color: #24292F"> np.subtract(x[</span><span style="color: #0550AE">0</span><span style="color: #24292F">:</span><span style="color: #0550AE">3</span><span style="color: #24292F">], T1) </span><span style="color: #CF222E">></span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F"> </span><span style="color: #CF222E">and</span><span style="color: #24292F"> x[</span><span style="color: #0550AE">2</span><span style="color: #24292F">] </span><span style="color: #CF222E">></span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">                Z </span><span style="color: #CF222E">+=</span><span style="color: #24292F"> </span><span style="color: #0550AE">1</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #6E7781"># ---------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">if</span><span style="color: #24292F"> max_Z </span><span style="color: #CF222E">&#x3C;</span><span style="color: #24292F"> Z:</span></span>
<span class="line"><span style="color: #24292F">            max_Z, rt_idx </span><span style="color: #CF222E">=</span><span style="color: #24292F"> Z, </span><span style="color: #0550AE">str</span><span style="color: #24292F">(i)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    cur_T, cur_R </span><span style="color: #CF222E">=</span><span style="color: #24292F"> poses[</span><span style="color: #0A3069">"T"</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> rt_idx], poses[</span><span style="color: #0A3069">"R"</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> rt_idx]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">if</span><span style="color: #24292F"> cur_T[</span><span style="color: #0550AE">2</span><span style="color: #24292F">] </span><span style="color: #CF222E">&#x3C;</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">        cur_T </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">-</span><span style="color: #24292F">cur_T</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> cur_T, cur_R</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">cur_T, cur_R </span><span style="color: #CF222E">=</span><span style="color: #24292F"> recover_pose(E, kp1, kp2, K)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">linear_triangulation</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">    T1: np.ndarray,</span></span>
<span class="line"><span style="color: #C9D1D9">    R1: np.ndarray,</span></span>
<span class="line"><span style="color: #C9D1D9">    T2: np.ndarray,</span></span>
<span class="line"><span style="color: #C9D1D9">    R2: np.ndarray,</span></span>
<span class="line"><span style="color: #C9D1D9">    pt1: np.ndarray,</span></span>
<span class="line"><span style="color: #C9D1D9">    pt2: np.ndarray,</span></span>
<span class="line"><span style="color: #C9D1D9">    K: np.ndarray,</span></span>
<span class="line"><span style="color: #C9D1D9">)-> np.ndarray:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"""Linear triangulation."""</span></span>
<span class="line"><span style="color: #C9D1D9">    P1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> K </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> np.hstack((R1, </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">R1 </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> T1))</span></span>
<span class="line"><span style="color: #C9D1D9">    P2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> K </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> np.hstack((R2, </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">R2 </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> T2))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    X </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(pt1)):</span></span>
<span class="line"><span style="color: #C9D1D9">        x1, x2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pt1[i], pt2[i]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        A1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> x1[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> P1[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, :] </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> P1[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, :]</span></span>
<span class="line"><span style="color: #C9D1D9">        A2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> x1[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> P1[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, :] </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> P1[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, :]</span></span>
<span class="line"><span style="color: #C9D1D9">        A3 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> x2[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> P2[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, :] </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> P2[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, :]</span></span>
<span class="line"><span style="color: #C9D1D9">        A4 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> x2[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> P2[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, :] </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> P2[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, :]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        A </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.asarray([A1, A2, A3, A4])</span></span>
<span class="line"><span style="color: #C9D1D9">        U, S, V </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.linalg.svd(A)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        V </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> V[</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        V </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> V </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> V[</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        X.append(V)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> np.asarray(X)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">recover_pose</span><span style="color: #C9D1D9">(E: np.ndarray, pt1, pt2, K: np.ndarray):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"""Recovers the camera pose."""</span></span>
<span class="line"><span style="color: #C9D1D9">    W </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.asarray([</span></span>
<span class="line"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">],</span></span>
<span class="line"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">,  </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">],</span></span>
<span class="line"><span style="color: #C9D1D9">        [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,  </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    ])</span></span>
<span class="line"><span style="color: #C9D1D9">    U, S, V </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.linalg.svd(E)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    poses </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"T1"</span><span style="color: #C9D1D9">:  U[:, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">].reshape(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"T2"</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">U[:, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">].reshape(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"T3"</span><span style="color: #C9D1D9">:  U[:, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">].reshape(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"T4"</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">U[:, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">].reshape(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"R1"</span><span style="color: #C9D1D9">:  U </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> W   </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> V,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"R2"</span><span style="color: #C9D1D9">:  U </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> W   </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> V,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"R3"</span><span style="color: #C9D1D9">:  U </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> W.T </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> V,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"R4"</span><span style="color: #C9D1D9">:  U </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> W.T </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> V</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">        T, R </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> poses[</span><span style="color: #A5D6FF">"T"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(i)], poses[</span><span style="color: #A5D6FF">"R"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(i)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> np.linalg.det(R) </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">            T </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">T</span></span>
<span class="line"><span style="color: #C9D1D9">            R </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">R</span></span>
<span class="line"><span style="color: #C9D1D9">            poses[</span><span style="color: #A5D6FF">"T"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(i)], poses[</span><span style="color: #A5D6FF">"R"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(i)] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> T, R</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        I </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.identity(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        M </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.hstack((I, T.reshape(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        poses[</span><span style="color: #A5D6FF">"P"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(i)] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> K </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> R </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> M</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    max_Z, rt_idx </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">        T1, R1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> poses[</span><span style="color: #A5D6FF">"T"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(i)], poses[</span><span style="color: #A5D6FF">"R"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(i)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E"># ---------------------</span></span>
<span class="line"><span style="color: #C9D1D9">        T2, R2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.asarray([[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">],[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">],[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]]), np.identity(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        X </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> linear_triangulation(T2, R2, T1, R1, pt1, pt2, K)</span></span>
<span class="line"><span style="color: #C9D1D9">        Z </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(X.shape[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]):</span></span>
<span class="line"><span style="color: #C9D1D9">            x </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> X[j, :].reshape(</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> R1[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> np.subtract(x[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">:</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">], T1) </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">and</span><span style="color: #C9D1D9"> x[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">                Z </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E"># ---------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> max_Z </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> Z:</span></span>
<span class="line"><span style="color: #C9D1D9">            max_Z, rt_idx </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> Z, </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(i)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    cur_T, cur_R </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> poses[</span><span style="color: #A5D6FF">"T"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> rt_idx], poses[</span><span style="color: #A5D6FF">"R"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> rt_idx]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> cur_T[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        cur_T </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">cur_T</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> cur_T, cur_R</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">cur_T, cur_R </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> recover_pose(E, kp1, kp2, K)</span></span></code></pre></div>
</div>
<hr>
<p>Again, here is how to implement it in OpenCV:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #24292F">kp1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.array([pt </span><span style="color: #CF222E">for</span><span style="color: #24292F"> (idx, pt) </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #0550AE">enumerate</span><span style="color: #24292F">(kp1) </span><span style="color: #CF222E">if</span><span style="color: #24292F"> mask[idx] </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #0550AE">1</span><span style="color: #24292F">])</span></span>
<span class="line"><span style="color: #24292F">kp2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.array([pt </span><span style="color: #CF222E">for</span><span style="color: #24292F"> (idx, pt) </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #0550AE">enumerate</span><span style="color: #24292F">(kp2) </span><span style="color: #CF222E">if</span><span style="color: #24292F"> mask[idx] </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #0550AE">1</span><span style="color: #24292F">])</span></span>
<span class="line"><span style="color: #24292F">_, cur_R, cur_t, _ </span><span style="color: #CF222E">=</span><span style="color: #24292F"> cv2.recoverPose(E, kp2, kp1, K)</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #C9D1D9">kp1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.array([pt </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (idx, pt) </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">enumerate</span><span style="color: #C9D1D9">(kp1) </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> mask[idx] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">kp2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.array([pt </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (idx, pt) </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">enumerate</span><span style="color: #C9D1D9">(kp2) </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> mask[idx] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">_, cur_R, cur_t, _ </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> cv2.recoverPose(E, kp2, kp1, K)</span></span></code></pre></div>
</div>
<h2 id="trajectory"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#trajectory">#</a>Trajectory</h2>
<p>Denote the pose of the camera as <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span>, which should be initialized as:</p>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #24292F">R, T </span><span style="color: #CF222E">=</span><span style="color: #24292F"> np.identity(</span><span style="color: #0550AE">3</span><span style="color: #24292F">), np.zeros((</span><span style="color: #0550AE">3</span><span style="color: #24292F">, </span><span style="color: #0550AE">1</span><span style="color: #24292F">))</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #C9D1D9">R, T </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> np.identity(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">), np.zeros((</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">))</span></span></code></pre></div>
</div>
<p>We can update the trajectory of the camera by:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>t</mi><mo>=</mo><mi>t</mi><mo>+</mo><mi>R</mi><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">t = t + R t_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6984em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo>=</mo><msub><mi>R</mi><mi>i</mi></msub><mi>R</mi></mrow><annotation encoding="application/x-tex">R = R_i R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span></div>
<p></p><div class="language-python"><span class="lang">python</span><p></p>
<div data-rehype-pretty-code-fragment=""><pre data-language="python" data-theme="light"><code data-language="python" data-theme="light"><span class="line"><span style="color: #24292F">T </span><span style="color: #CF222E">=</span><span style="color: #24292F"> T </span><span style="color: #CF222E">+</span><span style="color: #24292F"> R </span><span style="color: #CF222E">@</span><span style="color: #24292F"> cur_T</span></span>
<span class="line"><span style="color: #24292F">R </span><span style="color: #CF222E">=</span><span style="color: #24292F"> cur_R </span><span style="color: #CF222E">@</span><span style="color: #24292F"> R</span></span></code></pre><pre data-language="python" data-theme="dark"><code data-language="python" data-theme="dark"><span class="line"><span style="color: #C9D1D9">T </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> T </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> R </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> cur_T</span></span>
<span class="line"><span style="color: #C9D1D9">R </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> cur_R </span><span style="color: #FF7B72">@</span><span style="color: #C9D1D9"> R</span></span></code></pre></div>
</div>
<p>That’s it! We can now move to the next pair of frames <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>I</mi><mrow><mi>i</mi><mo>+</mo><mn>2</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(I_{i+1}, I_{i+2})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> and repeat from <a href="#feature-detection">here</a>.</p>
<p>Of course, there are many details and optimizations (e.g. bundle adjustment) that can be added to improve the accuracy and performance of the VO system, but this should give a good starting point for building a monocular VO system.</p>
<h2 id="references"><a aria-hidden="true" tabindex="-1" class="header-anchor" href="#references">#</a>References</h2>
<ul>
<li><a href="https://cmsc426.github.io/sfm/" target="_blank" rel="noopener noreferrer">Structure from Motion (University of Maryland)</a></li>
<li><a href="https://www.cs.cmu.edu/~16385/s17/Slides/12.4_8Point_Algorithm.pdf" target="_blank" rel="noopener noreferrer">The 8-point algorithm (Carnegie Mellon University)</a></li>
<li><a href="https://www.crcv.ucf.edu/wp-content/uploads/2019/03/Lecture-13-FundamentalMatrix.pdf" target="_blank" rel="noopener noreferrer">Fundamental Matrix (University of Central Florida)</a></li>
<li><a href="https://www-users.cse.umn.edu/~hspark/CSci5980/nister.pdf" target="_blank" rel="noopener noreferrer">An Efficient Solution to the Five-Point Relative Pose Problem</a>. <em>David Nistér</em>. IEEE Transactions on Pattern Analysis and Machine Intelligence, 2004.</li>
<li><a href="https://avisingh599.github.io/vision/monocular-vo/" target="_blank" rel="noopener noreferrer">Monocular Visual Odometry using OpenCV</a></li>
</ul>
  </div><div prose-lg mx-auto class="astro-GVPN4U4B">
    <div class="grid md:grid-cols-2 text-[0.95em] astro-GVPN4U4B">
      <a href="https://github.com/Renovamen/renovamen.github.io/edit/main/src/content/blog/2022-12-19-monocular-visual-odometry.md" title="Edit link" target="_blank" rel="noopener noreferrer" class="hover:underline text-c-active astro-GVPN4U4B">
        <span class="i-tabler:edit w-4.5 h-4.5 align-text-top astro-GVPN4U4B"></span>
        Edit this page on GitHub
      </a>
      <span md:text-right text-c-light class="astro-GVPN4U4B">
        <span class="i-ic:round-update w-4.5 h-4.5 astro-GVPN4U4B"></span>
        Last updated:
        Invalid Date
      </span>
    </div>

    <div class="grid md:grid-cols-2 mt-3 pt-3 text-[0.95em] border-t border-c astro-GVPN4U4B">
          <span class="prev astro-GVPN4U4B">
            <a href="/posts/2022-06-28-new-mac" class="hover:underline astro-GVPN4U4B">
                What to install after getting a new Macbook
              </a>
          </span>
          <span class="next text-right astro-GVPN4U4B">
            <a href="/posts/2022-12-29-natural-gradient-decent" class="hover:underline astro-GVPN4U4B">
                Natural Gradient Decent
              </a>
          </span>
        </div>

    <div mt-20 class="astro-GVPN4U4B">
      <astro-island uid="Z2kk7RH" component-url="/_astro/Giscus.0d0b339f.js" component-export="default" renderer-url="/_astro/client.7b0202fb.js" props="{&quot;class&quot;:[0,&quot;astro-GVPN4U4B&quot;]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;Giscus&quot;,&quot;value&quot;:true}"></astro-island>
    </div>
  </div>
      </div>
      <footer font="ui" text="sm center c-lighter" m="t-20">
  © Xiaohan Zou 2023 <br>
  A dragon lost in human world
</footer>
    </main>
  </body></html>

